<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Testcase Manager</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo, useRef } = React;

    const API_BASE = 'http://localhost:3001/api';
    
    // Extract instance from URL path
    const getInstanceFromPath = () => {
      const pathParts = window.location.pathname.split('/').filter(Boolean);
      return pathParts[0] || null;
    };
    
    // Get API URL for current instance
    const getApiUrl = (instance, path) => {
      if (!instance) return `${API_BASE}${path}`;
      return `${API_BASE}/${instance}${path}`;
    };

    // Icons as simple components
    const Icon = ({ name, className = "" }) => (
      <i className={`fas fa-${name} ${className}`}></i>
    );

    // Status Badge Component
    const StatusBadge = ({ status }) => {
      if (!status) return <span className="text-xs px-2 py-1 bg-gray-200 text-gray-600 rounded">Offen</span>;
      
      const styles = {
        PASSED: 'bg-green-100 text-green-800',
        FAILED: 'bg-red-100 text-red-800',
        SKIPPED: 'bg-yellow-100 text-yellow-800'
      };
      
      const icons = {
        PASSED: 'check-circle',
        FAILED: 'times-circle',
        SKIPPED: 'minus-circle'
      };
      
      return (
        <span className={`text-xs px-2 py-1 rounded flex items-center gap-1 ${styles[status]}`}>
          <Icon name={icons[status]} />
          {status}
        </span>
      );
    };

    // Status Selector Component
    const StatusSelector = ({ value, onChange, size = 'normal' }) => {
      const baseClasses = size === 'small' ? 'text-xs px-2 py-1' : 'text-sm px-3 py-2';
      
      return (
        <select 
          value={value || ''} 
          onChange={(e) => onChange(e.target.value || null)}
          className={`${baseClasses} border rounded bg-white focus:outline-none focus:ring-2 focus:ring-blue-500`}
        >
          <option value="">-- Status wählen --</option>
          <option value="PASSED">✓ PASSED</option>
          <option value="FAILED">✗ FAILED</option>
          <option value="SKIPPED">○ SKIPPED</option>
        </select>
      );
    };

    // Status Bubbles Component for navigation
    const StatusBubbles = ({ testcases }) => {
      const counts = { passed: 0, failed: 0, skipped: 0, open: 0 };
      
      testcases.forEach(tc => {
        if (tc.status === 'PASSED') counts.passed++;
        else if (tc.status === 'FAILED') counts.failed++;
        else if (tc.status === 'SKIPPED') counts.skipped++;
        else counts.open++;
      });
      
      return (
        <div className="flex gap-1">
          {counts.passed > 0 && (
            <span className="text-xs px-1.5 py-0.5 rounded-full bg-green-500 text-white min-w-[18px] text-center" title="Passed">
              {counts.passed}
            </span>
          )}
          {counts.failed > 0 && (
            <span className="text-xs px-1.5 py-0.5 rounded-full bg-red-500 text-white min-w-[18px] text-center" title="Failed">
              {counts.failed}
            </span>
          )}
          {counts.skipped > 0 && (
            <span className="text-xs px-1.5 py-0.5 rounded-full bg-yellow-500 text-white min-w-[18px] text-center" title="Skipped">
              {counts.skipped}
            </span>
          )}
          {counts.open > 0 && (
            <span className="text-xs px-1.5 py-0.5 rounded-full bg-gray-400 text-white min-w-[18px] text-center" title="Offen">
              {counts.open}
            </span>
          )}
        </div>
      );
    };

    // Hashtag Badges Component for displaying RefFunction and RefUser
    const HashtagBadges = ({ refFunctions = [], refUsers = [], maxShow = 3, compact = false }) => {
      const allTags = [
        ...refFunctions.map(f => ({ type: 'function', name: f })),
        ...refUsers.map(u => ({ type: 'user', name: u }))
      ];
      
      if (allTags.length === 0) return null;
      
      const visibleTags = allTags.slice(0, maxShow);
      const hiddenCount = allTags.length - maxShow;
      
      return (
        <div className={`flex flex-wrap gap-1 ${compact ? '' : 'mt-1'}`}>
          {visibleTags.map((tag, idx) => (
            <span 
              key={`${tag.type}-${tag.name}-${idx}`}
              className={`inline-flex items-center text-xs px-1.5 py-0.5 rounded ${
                tag.type === 'function' 
                  ? 'bg-cyan-100 text-cyan-700' 
                  : 'bg-pink-100 text-pink-700'
              }`}
              title={`${tag.type === 'function' ? 'Funktion' : 'Benutzer'}: ${tag.name}`}
            >
              <span className="font-bold mr-0.5">{tag.type === 'function' ? '#' : '@'}</span>
              {tag.name}
            </span>
          ))}
          {hiddenCount > 0 && (
            <span className="text-xs text-gray-400" title={allTags.slice(maxShow).map(t => `${t.type === 'function' ? '#' : '@'}${t.name}`).join(', ')}>
              +{hiddenCount}
            </span>
          )}
        </div>
      );
    };

    // Variable Text Component for displaying and editing variables in text
    // Variables are identified by $variableName pattern
    const VariableText = ({ 
      text, 
      variables = {}, 
      allVariables = {}, // All variables from the entire testcase
      onVariableClick = null, // If provided, clicking a variable opens edit mode
      showValues = false // If true, show saved values (for Command display)
    }) => {
      const [editingVar, setEditingVar] = React.useState(null);
      const [inputValue, setInputValue] = React.useState('');
      const inputRef = React.useRef(null);
      
      React.useEffect(() => {
        if (editingVar && inputRef.current) {
          inputRef.current.focus();
        }
      }, [editingVar]);
      
      if (!text) return null;
      
      // Regex to find variables: $followed by alphanumeric characters
      const varRegex = /(\$[a-zA-Z0-9]+)/g;
      const parts = text.split(varRegex);
      
      const handleVarClick = (varName) => {
        if (onVariableClick) {
          // Remove $ prefix for storage
          const cleanName = varName.substring(1);
          setEditingVar(cleanName);
          setInputValue(variables[cleanName] || allVariables[cleanName] || '');
        }
      };
      
      const handleSave = () => {
        if (editingVar && onVariableClick) {
          onVariableClick(editingVar, inputValue);
        }
        setEditingVar(null);
        setInputValue('');
      };
      
      const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
          handleSave();
        } else if (e.key === 'Escape') {
          setEditingVar(null);
          setInputValue('');
        }
      };
      
      return (
        <span className="variable-text">
          {parts.map((part, index) => {
            if (part.match(varRegex)) {
              const cleanName = part.substring(1); // Remove $
              const savedValue = variables[cleanName] || allVariables[cleanName] || '';
              const isEditing = editingVar === cleanName;
              
              if (isEditing) {
                return (
                  <span key={index} className="inline-flex items-center gap-1 mx-1">
                    <span className="text-amber-600 font-mono font-bold">{part}</span>
                    <span className="text-gray-500">=</span>
                    <input
                      ref={inputRef}
                      type="text"
                      value={inputValue}
                      onChange={(e) => setInputValue(e.target.value)}
                      onKeyDown={handleKeyDown}
                      onBlur={handleSave}
                      className="w-32 px-2 py-0.5 text-sm border border-amber-400 rounded focus:outline-none focus:ring-2 focus:ring-amber-300 bg-amber-50"
                      placeholder="Wert eingeben..."
                    />
                  </span>
                );
              }
              
              // For Command view (showValues) - show the value if it exists
              if (showValues && savedValue) {
                return (
                  <span 
                    key={index} 
                    className="inline-flex items-center gap-0.5 mx-0.5 px-1.5 py-0.5 bg-amber-100 text-amber-800 rounded font-mono text-sm"
                    title={`Variable ${part} = ${savedValue}`}
                  >
                    <span className="font-bold">{part}</span>
                    <span className="text-amber-500">=</span>
                    <span className="font-semibold text-amber-900">{savedValue}</span>
                  </span>
                );
              }
              
              // For ExpectedResult view - clickable to edit
              if (onVariableClick) {
                return (
                  <button
                    key={index}
                    onClick={() => handleVarClick(part)}
                    className={`inline-flex items-center gap-0.5 mx-0.5 px-1.5 py-0.5 rounded font-mono text-sm cursor-pointer transition-colors ${
                      savedValue 
                        ? 'bg-green-100 text-green-800 hover:bg-green-200' 
                        : 'bg-amber-100 text-amber-800 hover:bg-amber-200'
                    }`}
                    title={savedValue ? `${part} = ${savedValue} (klicken zum Bearbeiten)` : `${part} - Klicken um Wert zu setzen`}
                  >
                    <span className="font-bold">{part}</span>
                    {savedValue && (
                      <>
                        <span className="text-gray-400">=</span>
                        <span className="font-semibold">{savedValue}</span>
                      </>
                    )}
                  </button>
                );
              }
              
              // Default: just highlight the variable (no value, not editable)
              return (
                <span 
                  key={index} 
                  className="inline-flex items-center mx-0.5 px-1.5 py-0.5 bg-amber-100 text-amber-800 rounded font-mono text-sm"
                  title={`Variable: ${part}`}
                >
                  {part}
                </span>
              );
            }
            return <span key={index}>{part}</span>;
          })}
        </span>
      );
    };

    // Instance Selector Component (shown when no instance is selected)
    const InstanceSelector = () => {
      const [instances, setInstances] = useState([]);
      const [templates, setTemplates] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [newInstanceName, setNewInstanceName] = useState('');
      const [selectedTemplateId, setSelectedTemplateId] = useState('');
      const [creating, setCreating] = useState(false);
      const [loadingTemplates, setLoadingTemplates] = useState(false);

      const loadInstances = async () => {
        setLoading(true);
        try {
          const response = await fetch(`${API_BASE}/instances`);
          const data = await response.json();
          if (response.ok) {
            setInstances(data.instances || []);
          } else {
            setError(data.error);
          }
        } catch (err) {
          setError('Verbindung zum Server fehlgeschlagen');
        }
        setLoading(false);
      };

      const loadTemplates = async () => {
        setLoadingTemplates(true);
        try {
          const response = await fetch(`${API_BASE}/templates`);
          const data = await response.json();
          if (response.ok) {
            setTemplates(data.templates || []);
          }
        } catch (err) {
          console.error('Error loading templates:', err);
        }
        setLoadingTemplates(false);
      };

      useEffect(() => {
        loadInstances();
      }, []);

      const openCreateModal = () => {
        setShowCreateModal(true);
        setNewInstanceName('');
        setSelectedTemplateId('');
        loadTemplates();
      };

      const createInstance = async () => {
        if (!newInstanceName.trim()) return;
        
        if (!/^[a-zA-Z0-9_-]+$/.test(newInstanceName)) {
          setError('Ungültiger Name. Erlaubt: a-z, A-Z, 0-9, _ und -');
          return;
        }
        
        setCreating(true);
        try {
          const body = { name: newInstanceName };
          if (selectedTemplateId) {
            body.templateId = selectedTemplateId;
          }
          
          const response = await fetch(`${API_BASE}/instances`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const data = await response.json();
          if (response.ok) {
            window.location.href = `/${newInstanceName}`;
          } else {
            setError(data.error);
          }
        } catch (err) {
          setError('Fehler beim Erstellen der Instanz');
        }
        setCreating(false);
      };

      const openInstance = (instanceId) => {
        window.location.href = `/${instanceId}`;
      };

      const selectedTemplate = templates.find(t => t.id === selectedTemplateId);

      if (loading) {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-100">
          <header className="bg-gradient-to-r from-blue-700 to-blue-900 text-white py-6 shadow-lg">
            <div className="max-w-4xl mx-auto px-4">
              <h1 className="text-3xl font-bold flex items-center gap-3">
                <Icon name="clipboard-check" />
                Testcase Manager
              </h1>
              <p className="text-blue-200 mt-2">Wählen Sie eine Instanz oder erstellen Sie eine neue</p>
            </div>
          </header>

          <main className="max-w-4xl mx-auto px-4 py-8">
            {error && (
              <div className="mb-6 p-4 bg-red-100 text-red-700 rounded-lg flex items-center gap-2">
                <Icon name="exclamation-circle" />
                {error}
                <button onClick={() => setError(null)} className="ml-auto">
                  <Icon name="times" />
                </button>
              </div>
            )}

            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-semibold text-gray-800">
                  <Icon name="folder-open" className="mr-2 text-blue-500" />
                  Verfügbare Instanzen
                </h2>
                <button
                  onClick={openCreateModal}
                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"
                >
                  <Icon name="plus" />
                  Neue Instanz
                </button>
              </div>

              {instances.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <Icon name="folder" className="text-5xl text-gray-300 mb-4" />
                  <p>Keine Instanzen gefunden.</p>
                  <p className="text-sm mt-2">Erstellen Sie eine neue Instanz oder legen Sie einen Ordner im <code className="bg-gray-100 px-1 rounded">instances/</code> Verzeichnis an.</p>
                </div>
              ) : (
                <div className="grid gap-4">
                  {instances.map((instance) => (
                    <button
                      key={instance.id}
                      onClick={() => openInstance(instance.id)}
                      className="w-full text-left p-4 border rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors group"
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex items-start gap-4">
                          <div className="p-3 bg-blue-100 rounded-lg text-blue-600 group-hover:bg-blue-200">
                            <Icon name="box" className="text-xl" />
                          </div>
                          <div>
                            <h3 className="font-semibold text-gray-800 group-hover:text-blue-700">
                              {instance.name}
                            </h3>
                            <p className="text-sm text-gray-500">ID: {instance.id}</p>
                            {instance.manufacturer && (
                              <p className="text-sm text-gray-500">Hersteller: {instance.manufacturer}</p>
                            )}
                            {instance.version && (
                              <p className="text-sm text-gray-500">Version: {instance.version}</p>
                            )}
                            <div className="flex gap-4 mt-2 text-xs text-gray-400">
                              <span><Icon name="folder" className="mr-1" />{instance.moduleCount} Module</span>
                              <span>
                                <Icon name="file-code" className="mr-1" />
                                {instance.profilesCompleted && instance.filteredTestcaseCount !== instance.testcaseCount 
                                  ? `${instance.filteredTestcaseCount}/${instance.testcaseCount}` 
                                  : instance.testcaseCount} Testcases
                              </span>
                              {instance.hasProfiles && (
                                instance.profilesCompleted ? (
                                  <span className="text-green-500">
                                    <Icon name="check-circle" className="mr-1" />
                                    ICS ✓ ({instance.activeProfileCount} Profile)
                                  </span>
                                ) : (
                                  <span className="text-yellow-500">
                                    <Icon name="edit" className="mr-1" />
                                    ICS nicht ausgefüllt
                                  </span>
                                )
                              )}
                            </div>
                          </div>
                        </div>
                        <Icon name="arrow-right" className="text-gray-400 group-hover:text-blue-500" />
                      </div>
                    </button>
                  ))}
                </div>
              )}
            </div>

            <div className="text-center text-gray-400 text-sm">
              <p>Instanzen werden im Ordner <code className="bg-gray-200 px-1 rounded">instances/</code> verwaltet.</p>
              <p className="mt-1">Templates befinden sich im Ordner <code className="bg-gray-200 px-1 rounded">templates/</code>.</p>
            </div>
          </main>

          {/* Create Instance Modal */}
          {showCreateModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg p-6 w-full max-w-lg shadow-xl">
                <h3 className="text-lg font-semibold mb-4">
                  <Icon name="plus-circle" className="mr-2 text-green-500" />
                  Neue Instanz erstellen
                </h3>
                
                {/* Instance Name */}
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Instanz-Name (URL-ID)
                  </label>
                  <input
                    type="text"
                    value={newInstanceName}
                    onChange={(e) => setNewInstanceName(e.target.value)}
                    className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="meine-tse-v1"
                    pattern="[a-zA-Z0-9_-]+"
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    Erlaubt: a-z, A-Z, 0-9, _ und -
                  </p>
                </div>

                {/* Template Selection */}
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    <Icon name="copy" className="mr-1" />
                    Template (optional)
                  </label>
                  
                  {loadingTemplates ? (
                    <div className="text-center py-4 text-gray-500">
                      <div className="loading-spinner inline-block"></div>
                      <span className="ml-2">Lade Templates...</span>
                    </div>
                  ) : templates.length === 0 ? (
                    <div className="p-3 bg-gray-50 rounded border text-gray-500 text-sm">
                      <Icon name="info-circle" className="mr-1" />
                      Keine Templates verfügbar. Erstellen Sie einen Ordner in <code className="bg-gray-200 px-1 rounded">templates/</code> mit einer <code className="bg-gray-200 px-1 rounded">profiles-template.xml</code>.
                    </div>
                  ) : (
                    <div className="space-y-2 max-h-64 overflow-y-auto">
                      {/* Empty / No Template Option */}
                      <label 
                        className={`block p-3 border rounded cursor-pointer transition-colors ${
                          selectedTemplateId === '' 
                            ? 'border-blue-500 bg-blue-50' 
                            : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                        }`}
                      >
                        <input
                          type="radio"
                          name="template"
                          value=""
                          checked={selectedTemplateId === ''}
                          onChange={() => setSelectedTemplateId('')}
                          className="sr-only"
                        />
                        <div className="flex items-center gap-3">
                          <div className={`p-2 rounded ${selectedTemplateId === '' ? 'bg-blue-200 text-blue-700' : 'bg-gray-200 text-gray-500'}`}>
                            <Icon name="file" />
                          </div>
                          <div>
                            <div className="font-medium text-gray-800">Leere Instanz</div>
                            <div className="text-xs text-gray-500">Nur Basis-Konfiguration ohne Testcases</div>
                          </div>
                        </div>
                      </label>

                      {/* Template Options */}
                      {templates.map((template) => (
                        <label 
                          key={template.id}
                          className={`block p-3 border rounded cursor-pointer transition-colors ${
                            selectedTemplateId === template.id 
                              ? 'border-blue-500 bg-blue-50' 
                              : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                          }`}
                        >
                          <input
                            type="radio"
                            name="template"
                            value={template.id}
                            checked={selectedTemplateId === template.id}
                            onChange={() => setSelectedTemplateId(template.id)}
                            className="sr-only"
                          />
                          <div className="flex items-start gap-3">
                            <div className={`p-2 rounded ${selectedTemplateId === template.id ? 'bg-blue-200 text-blue-700' : 'bg-purple-100 text-purple-600'}`}>
                              <Icon name="layer-group" />
                            </div>
                            <div className="flex-1 min-w-0">
                              <div className="font-medium text-gray-800">{template.name}</div>
                              {template.description && (
                                <div className="text-xs text-gray-500 mt-1">{template.description}</div>
                              )}
                              <div className="flex gap-3 mt-1 text-xs text-gray-400">
                                <span><Icon name="folder" className="mr-1" />{template.moduleCount} Module</span>
                                <span><Icon name="file-code" className="mr-1" />{template.testcaseCount} Testcases</span>
                                <span><Icon name="id-badge" className="mr-1" />{template.profileCount} Profile</span>
                              </div>
                            </div>
                          </div>
                        </label>
                      ))}
                    </div>
                  )}
                </div>

                {/* Selected Template Info */}
                {selectedTemplate && (
                  <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm">
                    <div className="font-medium text-blue-800 mb-1">
                      <Icon name="info-circle" className="mr-1" />
                      Ausgewähltes Template: {selectedTemplate.name}
                    </div>
                    <div className="text-blue-600">
                      Die Instanz wird mit {selectedTemplate.moduleCount} Modulen, {selectedTemplate.testcaseCount} Testcases und {selectedTemplate.profileCount} Profilen erstellt.
                    </div>
                  </div>
                )}

                <div className="flex justify-end gap-3">
                  <button
                    onClick={() => { setShowCreateModal(false); setNewInstanceName(''); setSelectedTemplateId(''); }}
                    className="px-4 py-2 text-gray-600 hover:text-gray-800"
                  >
                    Abbrechen
                  </button>
                  <button
                    onClick={createInstance}
                    disabled={creating || !newInstanceName.trim()}
                    className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 flex items-center gap-2"
                  >
                    {creating ? (
                      <>
                        <div className="loading-spinner w-4 h-4"></div>
                        Erstelle...
                      </>
                    ) : (
                      <>
                        <Icon name="plus" />
                        Erstellen
                      </>
                    )}
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Main Application Component
    function TestcaseManager({ instance }) {
      const [structure, setStructure] = useState({ modules: [], root: '' });
      const [expandedModules, setExpandedModules] = useState(new Set());
      const [selectedCategory, setSelectedCategory] = useState(null);
      const [selectedModule, setSelectedModule] = useState(null);
      const [selectedTestcase, setSelectedTestcase] = useState(null);
      const [testcaseData, setTestcaseData] = useState(null);
      const [originalTestcaseData, setOriginalTestcaseData] = useState(null);
      const [view, setView] = useState('loading');
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      const [error, setError] = useState(null);
      const [notification, setNotification] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [searchResults, setSearchResults] = useState([]);
      const [isSearching, setIsSearching] = useState(false);
      const [showSearchResults, setShowSearchResults] = useState(false);
      const [profiles, setProfiles] = useState([]);
      const [expandedProfiles, setExpandedProfiles] = useState(new Set());
      const [selectedProfile, setSelectedProfile] = useState(null);
      
      // Hashtags (RefFunction and RefUser)
      const [hashtags, setHashtags] = useState({ functions: [], users: [] });
      const [selectedHashtag, setSelectedHashtag] = useState(null);
      
      // Navigation sidebar section (accordion - only one open at a time)
      const [activeNavSection, setActiveNavSection] = useState('modules'); // 'modules', 'profiles', 'hashtags'
      
      // Refs for scroll areas and height calculation
      const mainRef = useRef(null);
      const navRef = useRef(null);
      const headerRef = useRef(null);
      const accordionHeadersRef = useRef(null);
      
      // State for calculated nav content max height
      const [navContentMaxHeight, setNavContentMaxHeight] = useState('calc(100vh - 200px)');
      
      // Calculate nav content max height on mount, resize, and view change
      useEffect(() => {
        const calculateNavHeight = () => {
          // Only calculate if refs are available and sidebar is visible
          if (!headerRef.current || !accordionHeadersRef.current) {
            return;
          }
          const windowHeight = window.innerHeight;
          const headerHeight = headerRef.current.offsetHeight;
          const accordionHeight = accordionHeadersRef.current.offsetHeight;
          // Subtract header and accordion headers
          const maxHeight = windowHeight - headerHeight - accordionHeight;
          setNavContentMaxHeight(`${Math.max(100, maxHeight)}px`);
        };
        
        // Initial calculation with delay to ensure DOM is ready
        const timer = setTimeout(calculateNavHeight, 50);
        
        // Recalculate on resize
        window.addEventListener('resize', calculateNavHeight);
        
        return () => {
          window.removeEventListener('resize', calculateNavHeight);
          clearTimeout(timer);
        };
      }, [view]); // Re-run when view changes (especially when leaving 'loading' or 'checklist')
      
      // Scroll main content to top
      const scrollToTop = useCallback(() => {
        if (mainRef.current) {
          mainRef.current.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }, []);
      
      // Scroll navigation to top
      const scrollNavToTop = useCallback(() => {
        if (navRef.current) {
          navRef.current.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }, []);
      
      // Profile Configuration (ICS Checklist)
      const [profileConfig, setProfileConfig] = useState(null);
      const [activeProfiles, setActiveProfiles] = useState([]);
      const [showChecklist, setShowChecklist] = useState(false);
      const [checklistLoading, setChecklistLoading] = useState(false);
      const [expandedSections, setExpandedSections] = useState(new Set());
      
      // Testcase list filter (for filtering by ID/Title in lists)
      const [testcaseFilter, setTestcaseFilter] = useState('');
      
      // Notes and Attachments
      const [newNoteText, setNewNoteText] = useState('');
      const [addingNote, setAddingNote] = useState(false);
      const [uploadingFile, setUploadingFile] = useState(false);
      const [attachmentDescription, setAttachmentDescription] = useState('');
      
      // Dashboard
      const [dashboardData, setDashboardData] = useState(null);
      const [dashboardLoading, setDashboardLoading] = useState(false);

      // ============================================
      // URL Routing Functions
      // ============================================
      
      // Build URL from current state
      const buildUrl = useCallback((routeType, params = {}) => {
        const base = `/${instance}`;
        switch (routeType) {
          case 'dashboard':
            return base;
          case 'checklist':
            return `${base}/checklist`;
          case 'category':
            return `${base}/category/${encodeURIComponent(params.module)}/${encodeURIComponent(params.category)}`;
          case 'profile':
            return `${base}/profile/${encodeURIComponent(params.profile)}`;
          case 'hashtag':
            return `${base}/hashtag/${encodeURIComponent(params.type)}/${encodeURIComponent(params.hashtag)}`;
          case 'testcase':
            return `${base}/testcase/${encodeURIComponent(params.testcaseId)}`;
          case 'search':
            return `${base}/search?q=${encodeURIComponent(params.query)}`;
          default:
            return base;
        }
      }, [instance]);

      // Update URL without triggering navigation
      const updateUrl = useCallback((routeType, params = {}, replace = false) => {
        const url = buildUrl(routeType, params);
        if (replace) {
          window.history.replaceState({ routeType, params }, '', url);
        } else {
          window.history.pushState({ routeType, params }, '', url);
        }
      }, [buildUrl]);

      // Update document title based on current view
      const updateTitle = useCallback((routeType, params = {}) => {
        const productName = profileConfig?.metadata?.productName || instance;
        let title = productName;
        
        switch (routeType) {
          case 'dashboard':
            title = `Dashboard - ${productName}`;
            break;
          case 'checklist':
            title = `ICS Checkliste - ${productName}`;
            break;
          case 'category':
            title = `${params.category} - ${productName}`;
            break;
          case 'profile':
            title = `Profil ${params.profile} - ${productName}`;
            break;
          case 'hashtag':
            title = `#${params.hashtag} - ${productName}`;
            break;
          case 'testcase':
            title = `${params.testcaseId} - ${productName}`;
            break;
          case 'search':
            title = `Suche: ${params.query} - ${productName}`;
            break;
          default:
            title = productName;
        }
        document.title = title;
      }, [instance, profileConfig]);

      // Parse URL and return route info
      const parseUrl = useCallback(() => {
        const path = window.location.pathname;
        const searchParams = new URLSearchParams(window.location.search);
        
        // Remove leading slash and split
        const parts = path.substring(1).split('/');
        
        // First part should be instance name
        if (parts[0] !== instance) {
          return { type: 'dashboard', params: {} };
        }
        
        // No more parts = dashboard
        if (parts.length === 1 || !parts[1]) {
          return { type: 'dashboard', params: {} };
        }
        
        const routeType = parts[1];
        
        switch (routeType) {
          case 'checklist':
            return { type: 'checklist', params: {} };
          case 'category':
            if (parts.length >= 4) {
              return { 
                type: 'category', 
                params: { 
                  module: decodeURIComponent(parts[2]), 
                  category: decodeURIComponent(parts[3]) 
                } 
              };
            }
            break;
          case 'profile':
            if (parts.length >= 3) {
              return { 
                type: 'profile', 
                params: { profile: decodeURIComponent(parts[2]) } 
              };
            }
            break;
          case 'hashtag':
            if (parts.length >= 4) {
              return { 
                type: 'hashtag', 
                params: { 
                  type: decodeURIComponent(parts[2]),
                  hashtag: decodeURIComponent(parts[3]) 
                } 
              };
            }
            break;
          case 'testcase':
            if (parts.length >= 3) {
              return { 
                type: 'testcase', 
                params: { testcaseId: decodeURIComponent(parts[2]) } 
              };
            }
            break;
          case 'search':
            const query = searchParams.get('q') || '';
            if (query) {
              return { type: 'search', params: { query } };
            }
            break;
        }
        
        return { type: 'dashboard', params: {} };
      }, [instance]);

      // Navigate to route based on URL info (used for initial load and popstate)
      const navigateToRoute = useCallback(async (routeInfo, isInitial = false) => {
        const { type, params } = routeInfo;
        
        switch (type) {
          case 'dashboard':
            setView('browser');
            setSelectedModule(null);
            setSelectedCategory(null);
            setSelectedProfile(null);
            setSelectedHashtag(null);
            setSelectedTestcase(null);
            setTestcaseData(null);
            setShowSearchResults(false);
            setShowChecklist(false);
            if (!isInitial) updateTitle('dashboard');
            break;
            
          case 'checklist':
            setShowChecklist(true);
            setView('checklist');
            if (!isInitial) updateTitle('checklist');
            break;
            
          case 'category':
            // Find module and category in structure
            const targetModule = structure.modules.find(m => m.name === params.module);
            if (targetModule) {
              const targetCategory = targetModule.categories.find(c => c.name === params.category);
              if (targetCategory) {
                setSelectedModule(targetModule);
                setSelectedCategory(targetCategory);
                setSelectedTestcase(null);
                setTestcaseData(null);
                setView('list');
                setShowSearchResults(false);
                setSelectedProfile(null);
                setSelectedHashtag(null);
                // Expand the module
                setExpandedModules(prev => new Set([...prev, targetModule.name]));
                if (!isInitial) updateTitle('category', params);
              } else {
                // Category not found, fall back to dashboard
                setView('browser');
                updateUrl('dashboard', {}, true);
                updateTitle('dashboard');
              }
            } else {
              // Module not found, fall back to dashboard
              setView('browser');
              updateUrl('dashboard', {}, true);
              updateTitle('dashboard');
            }
            break;
            
          case 'profile':
            // Find profile in profiles list
            const targetProfile = profiles.find(p => p.name === params.profile);
            if (targetProfile) {
              setSelectedProfile(targetProfile);
              setSelectedHashtag(null);
              setSelectedModule(null);
              setSelectedCategory(null);
              setSelectedTestcase(null);
              setTestcaseData(null);
              setView('profile');
              setShowSearchResults(false);
              // Expand the profile
              setExpandedProfiles(prev => new Set([...prev, targetProfile.name]));
              if (!isInitial) updateTitle('profile', params);
            } else {
              // Profile not found, fall back to dashboard
              setView('browser');
              updateUrl('dashboard', {}, true);
              updateTitle('dashboard');
            }
            break;
            
          case 'testcase':
            // Find testcase in structure
            let foundTestcase = null;
            let foundModule = null;
            let foundCategory = null;
            
            for (const mod of structure.modules) {
              for (const cat of mod.categories) {
                const tc = cat.testcases.find(t => t.id === params.testcaseId);
                if (tc) {
                  foundTestcase = tc;
                  foundModule = mod;
                  foundCategory = cat;
                  break;
                }
              }
              if (foundTestcase) break;
            }
            
            if (foundTestcase && foundModule && foundCategory) {
              setSelectedModule(foundModule);
              setSelectedCategory(foundCategory);
              // Load testcase data
              try {
                const response = await fetch(
                  getApiUrl(instance, `/testcase/${encodeURIComponent(foundModule.path)}/${encodeURIComponent(foundCategory.path)}/${encodeURIComponent(foundTestcase.filename)}`)
                );
                const data = await response.json();
                if (response.ok) {
                  setTestcaseData(data);
                  setOriginalTestcaseData(JSON.parse(JSON.stringify(data)));
                  setSelectedTestcase(foundTestcase);
                  setView('detail');
                  // Expand module
                  setExpandedModules(prev => new Set([...prev, foundModule.name]));
                  if (!isInitial) updateTitle('testcase', params);
                } else {
                  // Error loading testcase, fall back to dashboard
                  setView('browser');
                  updateUrl('dashboard', {}, true);
                  updateTitle('dashboard');
                }
              } catch (err) {
                console.error('Error loading testcase:', err);
                // Error, fall back to dashboard
                setView('browser');
                updateUrl('dashboard', {}, true);
                updateTitle('dashboard');
              }
            } else {
              // Testcase not found, fall back to dashboard
              setView('browser');
              updateUrl('dashboard', {}, true);
              updateTitle('dashboard');
            }
            break;
            
          case 'hashtag':
            // Find hashtag in hashtags list
            const allHashtags = [...hashtags.functions, ...hashtags.users];
            const targetHashtag = allHashtags.find(h => h.name === params.hashtag && h.type === params.type);
            if (targetHashtag) {
              setSelectedHashtag(targetHashtag);
              setSelectedProfile(null);
              setSelectedModule(null);
              setSelectedCategory(null);
              setSelectedTestcase(null);
              setTestcaseData(null);
              setView('hashtag');
              setShowSearchResults(false);
              if (!isInitial) updateTitle('hashtag', params);
            } else {
              // Hashtag not found, fall back to dashboard
              setView('browser');
              updateUrl('dashboard', {}, true);
              updateTitle('dashboard');
            }
            break;
            
          case 'search':
            if (params.query) {
              setSearchQuery(params.query);
              // Perform search
              try {
                const response = await fetch(getApiUrl(instance, `/search?q=${encodeURIComponent(params.query)}`));
                const data = await response.json();
                if (response.ok) {
                  setSearchResults(data.results);
                  setShowSearchResults(true);
                  setView('search');
                  if (!isInitial) updateTitle('search', params);
                }
              } catch (err) {
                console.error('Error performing search:', err);
              }
            }
            break;
        }
      }, [structure, profiles, hashtags, instance, updateTitle]);

      // Handle browser back/forward
      useEffect(() => {
        const handlePopState = (event) => {
          const routeInfo = parseUrl();
          navigateToRoute(routeInfo, false);
        };
        
        window.addEventListener('popstate', handlePopState);
        return () => window.removeEventListener('popstate', handlePopState);
      }, [parseUrl, navigateToRoute]);

      // Load dashboard data
      const loadDashboard = useCallback(async () => {
        setDashboardLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/dashboard'));
          const data = await response.json();
          if (response.ok) {
            setDashboardData(data);
          }
        } catch (err) {
          console.error('Error loading dashboard:', err);
        }
        setDashboardLoading(false);
      }, [instance]);

      // PDF Export function
      const exportPdf = useCallback(async () => {
        try {
          showNotification('PDF wird generiert...', 'info');
          
          // Build query parameters for filtering
          const params = new URLSearchParams();
          if (profileConfig && profileConfig.completed && activeProfiles.length > 0) {
            params.set('profiles', activeProfiles.join(','));
            params.set('filterMode', profileConfig.templateConfiguration?.profileFilterMode || 'OR');
          }
          
          const url = getApiUrl(instance, '/export/pdf') + (params.toString() ? '?' + params.toString() : '');
          
          // Fetch PDF as blob
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error('PDF Export fehlgeschlagen');
          }
          
          const blob = await response.blob();
          const downloadUrl = window.URL.createObjectURL(blob);
          
          // Create download link
          const a = document.createElement('a');
          a.href = downloadUrl;
          a.download = `testcase-report-${instance}-${new Date().toISOString().split('T')[0]}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(downloadUrl);
          
          showNotification('PDF erfolgreich heruntergeladen!');
        } catch (err) {
          console.error('PDF Export error:', err);
          showNotification('Fehler beim PDF Export', 'error');
        }
      }, [instance, profileConfig, activeProfiles]);

      // DOCX Export function (with Word template)
      const exportDocx = useCallback(async (templateName = 'default-template') => {
        try {
          showNotification('Word-Dokument wird generiert...', 'info');
          
          // Build query parameters for filtering
          const params = new URLSearchParams();
          if (profileConfig && profileConfig.completed && activeProfiles.length > 0) {
            params.set('profiles', activeProfiles.join(','));
            params.set('filterMode', profileConfig.templateConfiguration?.profileFilterMode || 'OR');
          }
          params.set('template', templateName);
          
          const url = getApiUrl(instance, '/export/docx') + '?' + params.toString();
          
          // Fetch DOCX as blob
          const response = await fetch(url);
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || 'DOCX Export fehlgeschlagen');
          }
          
          const blob = await response.blob();
          const downloadUrl = window.URL.createObjectURL(blob);
          
          // Create download link
          const a = document.createElement('a');
          a.href = downloadUrl;
          a.download = `testcase-report-${instance}-${new Date().toISOString().split('T')[0]}.docx`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(downloadUrl);
          
          showNotification('Word-Dokument erfolgreich heruntergeladen!');
        } catch (err) {
          console.error('DOCX Export error:', err);
          showNotification(err.message || 'Fehler beim Word Export', 'error');
        }
      }, [instance, profileConfig, activeProfiles]);

      // Load folder structure
      const loadStructure = useCallback(async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(getApiUrl(instance, '/structure'));
          const data = await response.json();
          if (response.ok) {
            setStructure(data);
            // Auto-expand first module
            if (data.modules.length > 0) {
              setExpandedModules(new Set([data.modules[0].id]));
            }
          } else {
            setError(data.error);
          }
        } catch (err) {
          setError('Verbindung zum Server fehlgeschlagen. Stellen Sie sicher, dass der Server läuft.');
        }
        setLoading(false);
      }, [instance]);

      // Load profiles structure
      const loadProfiles = useCallback(async () => {
        try {
          const response = await fetch(getApiUrl(instance, '/profiles'));
          const data = await response.json();
          if (response.ok) {
            setProfiles(data.profiles);
          }
        } catch (err) {
          console.error('Error loading profiles:', err);
        }
      }, [instance]);

      // Load hashtags structure (RefFunction and RefUser)
      const loadHashtags = useCallback(async () => {
        try {
          const response = await fetch(getApiUrl(instance, '/hashtags'));
          const data = await response.json();
          if (response.ok) {
            setHashtags({
              functions: data.functions || [],
              users: data.users || []
            });
          }
        } catch (err) {
          console.error('Error loading hashtags:', err);
        }
      }, [instance]);

      // Load profile configuration (ICS Checklist)
      const loadProfileConfig = useCallback(async () => {
        setChecklistLoading(true);
        try {
          const response = await fetch(getApiUrl(instance, '/profile-config'));
          const data = await response.json();
          if (response.ok) {
            setProfileConfig(data);
            setActiveProfiles(data.derivedProfiles || []);
            // Expand all sections by default
            if (data.sections) {
              setExpandedSections(new Set(data.sections.map(s => s.id)));
            }
            return data;
          }
        } catch (err) {
          console.error('Error loading profile config:', err);
        }
        setChecklistLoading(false);
        return null;
      }, []);

      // Save profile configuration
      const saveProfileConfig = async (completed = false) => {
        setSaving(true);
        try {
          const dataToSave = {
            ...profileConfig,
            completed: completed
          };
          
          const response = await fetch(getApiUrl(instance, '/profile-config'), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSave)
          });
          
          const result = await response.json();
          if (response.ok) {
            setActiveProfiles(result.derivedProfiles || []);
            setProfileConfig(prev => ({ ...prev, completed: completed, derivedProfiles: result.derivedProfiles }));
            showNotification('Profil-Konfiguration gespeichert!');
            
            if (completed) {
              setShowChecklist(false);
              setView('browser');
              // Reload structure and profiles to apply filters
              loadStructure();
              loadProfiles();
            }
          } else {
            showNotification(result.error, 'error');
          }
        } catch (err) {
          showNotification('Fehler beim Speichern', 'error');
        }
        setSaving(false);
      };

      // Update answer in profile config
      const updateAnswer = (sectionId, questionId, values) => {
        setProfileConfig(prev => {
          const updated = {
            ...prev,
            sections: prev.sections.map(section => 
              section.id === sectionId 
                ? {
                    ...section,
                    questions: section.questions.map(q =>
                      q.id === questionId
                        ? { ...q, answer: { answered: values.length > 0, values: values } }
                        : q
                    )
                  }
                : section
            )
          };
          // Clear dependent questions if parent answer changed
          return clearDependentAnswers(updated, questionId);
        });
      };
      
      // Clear answers of questions that depend on changed question
      const clearDependentAnswers = (config, changedQuestionId) => {
        return {
          ...config,
          sections: config.sections.map(section => ({
            ...section,
            questions: section.questions.map(q => {
              // Check if this question has any dependency on the changed question
              const dependsOnChanged = q.dependsOn && q.dependsOn.conditions && 
                q.dependsOn.conditions.some(cond => cond.questionId === changedQuestionId);
              
              if (dependsOnChanged) {
                // Check if dependency is still satisfied
                if (!isQuestionDependencySatisfied(config, q)) {
                  return { ...q, answer: { answered: false, values: [] } };
                }
              }
              return q;
            })
          }))
        };
      };
      
      // Check if a question's dependencies are satisfied
      const isQuestionDependencySatisfied = (config, question) => {
        if (!question.dependsOn) return true;
        
        const cfg = config || profileConfig;
        const logic = question.dependsOn.logic || 'OR';
        const conditions = question.dependsOn.conditions || [];
        
        // If no conditions, check is satisfied
        if (conditions.length === 0) return true;
        
        // Helper to find a question by ID
        const findQuestion = (questionId) => {
          for (const section of cfg.sections) {
            for (const q of section.questions) {
              if (q.id === questionId) return q;
            }
          }
          return null;
        };
        
        // Check each condition
        const conditionResults = conditions.map(condition => {
          const parentQuestion = findQuestion(condition.questionId);
          if (!parentQuestion || !parentQuestion.answer.answered) return false;
          
          // Check if parent's answer matches any of the required values
          return condition.values.some(reqValue => 
            parentQuestion.answer.values.includes(reqValue)
          );
        });
        
        // Apply logic (OR = at least one must be true, AND = all must be true)
        if (logic === 'AND') {
          return conditionResults.every(result => result);
        } else {
          // Default to OR
          return conditionResults.some(result => result);
        }
      };
      
      // Calculate derived profiles from current config (client-side)
      const calculateDerivedProfilesLocal = () => {
        if (!profileConfig) return [];
        
        const activeProfiles = new Set();
        
        for (const section of profileConfig.sections) {
          for (const question of section.questions) {
            // Skip if question has unmet dependencies
            if (!isQuestionDependencySatisfied(profileConfig, question)) continue;
            if (!question.answer.answered) continue;
            
            const values = question.answer.values;
            
            for (const mapping of question.profileMappings) {
              let matches = false;
              
              if (question.type === 'boolean') {
                const boolValue = values[0]?.toLowerCase() === 'true';
                matches = (mapping.condition === 'true' && boolValue) ||
                         (mapping.condition === 'false' && !boolValue);
              } else if (question.type === 'choice' || question.type === 'multi-choice') {
                matches = values.includes(mapping.condition);
              }
              
              if (matches && mapping.profiles) {
                mapping.profiles.forEach(p => activeProfiles.add(p));
              }
            }
          }
        }
        
        return Array.from(activeProfiles).sort();
      };
      
      // Get all profiles covered by the checklist
      const getCoveredProfiles = () => {
        if (!profileConfig) return new Set();
        
        const covered = new Set();
        profileConfig.sections.forEach(section => {
          section.questions.forEach(q => {
            q.profileMappings.forEach(m => {
              if (m.profiles) {
                m.profiles.forEach(p => covered.add(p));
              }
            });
          });
        });
        return covered;
      };
      
      // Derived profiles calculated dynamically
      const derivedProfiles = React.useMemo(() => {
        return calculateDerivedProfilesLocal();
      }, [profileConfig]);

      // Check if testcase data has been modified
      const hasTestcaseChanges = React.useMemo(() => {
        if (!testcaseData || !originalTestcaseData) return false;
        return JSON.stringify(testcaseData) !== JSON.stringify(originalTestcaseData);
      }, [testcaseData, originalTestcaseData]);

      // Update metadata in profile config
      const updateMetadata = (field, value) => {
        setProfileConfig(prev => ({
          ...prev,
          metadata: { ...prev.metadata, [field]: value }
        }));
      };

      // Toggle section expansion
      const toggleSection = (sectionId) => {
        const newExpanded = new Set(expandedSections);
        if (newExpanded.has(sectionId)) {
          newExpanded.delete(sectionId);
        } else {
          newExpanded.add(sectionId);
        }
        setExpandedSections(newExpanded);
      };

      // Check if a profile is active (either from checklist or not covered by checklist)
      const isProfileActive = (profileName) => {
        // If no profile config or not completed, show all testcases
        if (!profileConfig || !profileConfig.completed) return true;
        
        // Profile is active only if it's in the activeProfiles list
        return activeProfiles.includes(profileName);
      };

      // Filter testcases based on active profiles
      const filterTestcasesByProfiles = (testcases) => {
        if (!profileConfig || !profileConfig.completed) return testcases;
        
        return testcases.filter(tc => {
          // If testcase has no profiles, always show
          if (!tc.profiles || tc.profiles.length === 0) return true;
          // Show if any of the testcase's profiles is active
          return tc.profiles.some(p => isProfileActive(p));
        });
      };

      // Filter profiles list based on active profiles, include empty profiles, and sort alphabetically
      const filterProfiles = (profilesList) => {
        if (!profileConfig || !profileConfig.completed) {
          // Not filtered - just sort alphabetically
          return [...profilesList].sort((a, b) => a.name.localeCompare(b.name));
        }
        
        // Get profiles that exist in testcases
        const existingProfiles = profilesList.filter(p => isProfileActive(p.name));
        const existingProfileNames = new Set(existingProfiles.map(p => p.name));
        
        // Add empty profiles for activeProfiles that don't exist in testcases
        const emptyProfiles = activeProfiles
          .filter(name => !existingProfileNames.has(name))
          .map(name => ({
            id: `empty-${name}`,
            name: name,
            testcases: [],
            isEmpty: true
          }));
        
        // Combine and sort alphabetically
        return [...existingProfiles, ...emptyProfiles].sort((a, b) => a.name.localeCompare(b.name));
      };

      // Initial load - check if checklist is completed
      // State for tracking if initial URL has been processed
      const [initialUrlProcessed, setInitialUrlProcessed] = useState(false);
      const [dataLoaded, setDataLoaded] = useState(false);
      
      useEffect(() => {
        const initApp = async () => {
          await loadProfileConfig();
          await loadStructure();
          await loadProfiles();
          await loadHashtags();
          await loadDashboard();
          setChecklistLoading(false);
          setDataLoaded(true);
        };
        
        initApp();
      }, []);

      // Handle initial URL routing after data is loaded
      useEffect(() => {
        if (!initialUrlProcessed && dataLoaded && structure.modules.length > 0) {
          const routeInfo = parseUrl();
          navigateToRoute(routeInfo, true);
          updateTitle(routeInfo.type, routeInfo.params);
          updateUrl(routeInfo.type, routeInfo.params, true);
          setInitialUrlProcessed(true);
        }
      }, [initialUrlProcessed, dataLoaded, structure, parseUrl, navigateToRoute, updateTitle, updateUrl]);

      // Search function
      const performSearch = async (query) => {
        if (!query || query.trim().length === 0) {
          setSearchResults([]);
          setShowSearchResults(false);
          return;
        }
        
        setIsSearching(true);
        try {
          const response = await fetch(getApiUrl(instance, `/search?q=${encodeURIComponent(query)}`));
          const data = await response.json();
          if (response.ok) {
            setSearchResults(data.results);
            setShowSearchResults(true);
            setView('search');
            // Update URL
            updateUrl('search', { query });
            updateTitle('search', { query });
          } else {
            showNotification(data.error, 'error');
          }
        } catch (err) {
          showNotification('Fehler bei der Suche', 'error');
        }
        setIsSearching(false);
      };

      const handleSearchSubmit = (e) => {
        e.preventDefault();
        performSearch(searchQuery);
      };

      const clearSearch = () => {
        setSearchQuery('');
        setSearchResults([]);
        setShowSearchResults(false);
        setView('browser');
        // Update URL to dashboard
        updateUrl('dashboard');
        updateTitle('dashboard');
      };

      const openSearchResult = (result) => {
        // Module/Category können Strings oder Objekte sein
        const modulePath = typeof result.module === 'object' ? result.module.path : result.module;
        const categoryPath = typeof result.category === 'object' ? result.category.path : result.category;
        
        // Find the actual module and category objects from structure
        const mod = structure.modules.find(m => m.path === modulePath || m.name === modulePath);
        const cat = mod?.categories.find(c => c.path === categoryPath || c.name === categoryPath);
        
        if (mod && cat) {
          setSelectedModule(mod);
          setSelectedCategory(cat);
        }
        // Load the testcase
        loadTestcaseFromSearch(result);
      };

      const loadTestcaseFromSearch = async (result) => {
        setLoading(true);
        try {
          // Module/Category können Strings oder Objekte sein
          const modulePath = typeof result.module === 'object' ? result.module.path : result.module;
          const categoryPath = typeof result.category === 'object' ? result.category.path : result.category;
          
          const response = await fetch(
            getApiUrl(instance, `/testcase/${encodeURIComponent(modulePath)}/${encodeURIComponent(categoryPath)}/${encodeURIComponent(result.filename)}`)
          );
          const data = await response.json();
          if (response.ok) {
            setTestcaseData(data);
            setOriginalTestcaseData(JSON.parse(JSON.stringify(data))); // Deep copy
            setSelectedTestcase(result);
            setView('detail');
            // Update URL
            updateUrl('testcase', { testcaseId: result.id });
            updateTitle('testcase', { testcaseId: result.id });
            // Scroll to top
            scrollToTop();
          } else {
            showNotification(data.error, 'error');
          }
        } catch (err) {
          showNotification('Fehler beim Laden des Testcases', 'error');
        }
        setLoading(false);
      };

      const showNotification = (message, type = 'success') => {
        setNotification({ message, type });
        setTimeout(() => setNotification(null), 3000);
      };

      const toggleModule = (moduleId) => {
        const newExpanded = new Set(expandedModules);
        if (newExpanded.has(moduleId)) {
          newExpanded.delete(moduleId);
        } else {
          newExpanded.add(moduleId);
        }
        setExpandedModules(newExpanded);
      };

      const selectCategory = (module, category) => {
        setSelectedModule(module);
        setSelectedCategory(category);
        setSelectedTestcase(null);
        setTestcaseData(null);
        setOriginalTestcaseData(null);
        setView('list');
        // Clear search, profile and hashtag state when selecting a category
        setShowSearchResults(false);
        setSearchResults([]);
        setSelectedProfile(null);
        setSelectedHashtag(null);
        setTestcaseFilter(''); // Clear testcase filter
        // Update URL
        updateUrl('category', { module: module.name, category: category.name });
        updateTitle('category', { module: module.name, category: category.name });
        // Scroll to top (both main and nav)
        scrollToTop();
        scrollNavToTop();
      };

      const toggleProfile = (profileId) => {
        const newExpanded = new Set(expandedProfiles);
        if (newExpanded.has(profileId)) {
          newExpanded.delete(profileId);
        } else {
          newExpanded.add(profileId);
        }
        setExpandedProfiles(newExpanded);
      };

      const selectProfile = (profile) => {
        setSelectedProfile(profile);
        setSelectedHashtag(null);
        setSelectedModule(null);
        setSelectedCategory(null);
        setSelectedTestcase(null);
        setTestcaseData(null);
        setOriginalTestcaseData(null);
        setView('profile');
        setShowSearchResults(false);
        setSearchResults([]);
        setTestcaseFilter(''); // Clear testcase filter
        // Update URL
        updateUrl('profile', { profile: profile.name });
        updateTitle('profile', { profile: profile.name });
        // Scroll to top (both main and nav)
        scrollToTop();
        scrollNavToTop();
      };

      const selectHashtag = (hashtag) => {
        setSelectedHashtag(hashtag);
        setSelectedProfile(null);
        setSelectedModule(null);
        setSelectedCategory(null);
        setSelectedTestcase(null);
        setTestcaseData(null);
        setOriginalTestcaseData(null);
        setView('hashtag');
        setShowSearchResults(false);
        setSearchResults([]);
        setTestcaseFilter(''); // Clear testcase filter
        // Update URL
        updateUrl('hashtag', { hashtag: hashtag.name, type: hashtag.type });
        updateTitle('hashtag', { hashtag: hashtag.name, type: hashtag.type });
        // Scroll to top (both main and nav)
        scrollToTop();
        scrollNavToTop();
      };

      const openProfileTestcase = (testcase) => {
        // Module/Category können Strings oder Objekte sein
        const modulePath = typeof testcase.module === 'object' ? testcase.module.path : testcase.module;
        const categoryPath = typeof testcase.category === 'object' ? testcase.category.path : testcase.category;
        
        // Find the actual module and category objects from structure
        const mod = structure.modules.find(m => m.path === modulePath || m.name === modulePath);
        const cat = mod?.categories.find(c => c.path === categoryPath || c.name === categoryPath);
        
        if (mod && cat) {
          setSelectedModule(mod);
          setSelectedCategory(cat);
        }
        loadTestcaseFromProfile(testcase);
      };

      const loadTestcaseFromProfile = async (testcase) => {
        setLoading(true);
        try {
          // Module/Category können Strings oder Objekte sein
          const modulePath = typeof testcase.module === 'object' ? testcase.module.path : testcase.module;
          const categoryPath = typeof testcase.category === 'object' ? testcase.category.path : testcase.category;
          
          const response = await fetch(
            getApiUrl(instance, `/testcase/${encodeURIComponent(modulePath)}/${encodeURIComponent(categoryPath)}/${encodeURIComponent(testcase.filename)}`)
          );
          const data = await response.json();
          if (response.ok) {
            setTestcaseData(data);
            setOriginalTestcaseData(JSON.parse(JSON.stringify(data))); // Deep copy
            setSelectedTestcase(testcase);
            setView('detail');
            // Update URL
            updateUrl('testcase', { testcaseId: testcase.id });
            updateTitle('testcase', { testcaseId: testcase.id });
            // Scroll to top
            scrollToTop();
          } else {
            showNotification(data.error, 'error');
          }
        } catch (err) {
          showNotification('Fehler beim Laden des Testcases', 'error');
        }
        setLoading(false);
      };

      const navigateToProfile = (profileName) => {
        // Find the profile in the profiles list
        const profile = profiles.find(p => p.name === profileName);
        if (profile) {
          selectProfile(profile);
        } else {
          showNotification(`Profil "${profileName}" nicht gefunden`, 'error');
        }
      };

      const loadTestcase = async (testcase) => {
        setLoading(true);
        try {
          const response = await fetch(
            getApiUrl(instance, `/testcase/${encodeURIComponent(selectedModule.path)}/${encodeURIComponent(selectedCategory.path)}/${encodeURIComponent(testcase.filename)}`)
          );
          const data = await response.json();
          if (response.ok) {
            setTestcaseData(data);
            setOriginalTestcaseData(JSON.parse(JSON.stringify(data))); // Deep copy
            setSelectedTestcase(testcase);
            setView('detail');
            // Update URL
            updateUrl('testcase', { testcaseId: testcase.id });
            updateTitle('testcase', { testcaseId: testcase.id });
            // Scroll to top
            scrollToTop();
          } else {
            showNotification(data.error, 'error');
          }
        } catch (err) {
          showNotification('Fehler beim Laden des Testcases', 'error');
        }
        setLoading(false);
      };

      const goBack = () => {
        if (view === 'detail') {
          if (showSearchResults) {
            setView('search');
            updateUrl('search', { query: searchQuery });
            updateTitle('search', { query: searchQuery });
          } else if (selectedProfile) {
            setView('profile');
            updateUrl('profile', { profile: selectedProfile.name });
            updateTitle('profile', { profile: selectedProfile.name });
          } else if (selectedHashtag) {
            setView('hashtag');
            updateUrl('hashtag', { hashtag: selectedHashtag.name, type: selectedHashtag.type });
            updateTitle('hashtag', { hashtag: selectedHashtag.name, type: selectedHashtag.type });
          } else if (selectedCategory) {
            setView('list');
            updateUrl('category', { module: selectedModule.name, category: selectedCategory.name });
            updateTitle('category', { module: selectedModule.name, category: selectedCategory.name });
          } else {
            setView('browser');
            updateUrl('dashboard');
            updateTitle('dashboard');
          }
          setSelectedTestcase(null);
          setTestcaseData(null);
          setOriginalTestcaseData(null);
        } else if (view === 'list') {
          setView('browser');
          setSelectedCategory(null);
          setSelectedModule(null);
          updateUrl('dashboard');
          updateTitle('dashboard');
        } else if (view === 'search') {
          setView('browser');
          setSearchQuery('');
          setSearchResults([]);
          setShowSearchResults(false);
          updateUrl('dashboard');
          updateTitle('dashboard');
        } else if (view === 'profile') {
          setView('browser');
          setSelectedProfile(null);
          updateUrl('dashboard');
          updateTitle('dashboard');
        } else if (view === 'hashtag') {
          setView('browser');
          setSelectedHashtag(null);
          updateUrl('dashboard');
          updateTitle('dashboard');
        } else if (view === 'checklist') {
          if (profileConfig?.completed) {
            setView('browser');
            setShowChecklist(false);
            updateUrl('dashboard');
            updateTitle('dashboard');
          }
          // If not completed, stay on checklist
        }
        // Scroll to top after navigation
        scrollToTop();
      };

      // Open checklist view
      const openChecklist = () => {
        setShowChecklist(true);
        setView('checklist');
        // Update URL
        updateUrl('checklist');
        updateTitle('checklist');
      };

      // Status calculation helpers
      const calculateStepStatus = (expectedResults) => {
        if (!expectedResults || !Array.isArray(expectedResults)) return null;
        const statuses = expectedResults.map(r => r.status).filter(s => s !== null && s !== undefined);
        if (statuses.length === 0) return null;
        if (statuses.includes('FAILED')) return 'FAILED';
        if (statuses.every(s => s === 'SKIPPED')) return 'SKIPPED';
        if (statuses.every(s => s === 'PASSED' || s === 'SKIPPED')) return 'PASSED';
        return null;
      };

      const calculateTestcaseStatus = (testSteps) => {
        if (!testSteps || !Array.isArray(testSteps)) return null;
        const statuses = testSteps.map(s => s.status).filter(s => s !== null && s !== undefined);
        if (statuses.length === 0) return null;
        if (statuses.includes('FAILED')) return 'FAILED';
        if (statuses.every(s => s === 'SKIPPED')) return 'SKIPPED';
        if (statuses.length === testSteps.length && statuses.every(s => s === 'PASSED' || s === 'SKIPPED')) return 'PASSED';
        return null;
      };

      const updateExpectedResultStatus = (stepIndex, resultIndex, status) => {
        const newData = { ...testcaseData };
        newData.testSteps = [...(newData.testSteps || [])];
        newData.testSteps[stepIndex] = { ...newData.testSteps[stepIndex] };
        newData.testSteps[stepIndex].expectedResults = [...(newData.testSteps[stepIndex].expectedResults || [])];
        newData.testSteps[stepIndex].expectedResults[resultIndex] = {
          ...newData.testSteps[stepIndex].expectedResults[resultIndex],
          status
        };
        
        newData.testSteps[stepIndex].status = calculateStepStatus(newData.testSteps[stepIndex].expectedResults);
        newData.status = calculateTestcaseStatus(newData.testSteps);
        newData.timestamp = new Date().toISOString();
        
        setTestcaseData(newData);
      };

      const updateExpectedResultActual = (stepIndex, resultIndex, actualResult) => {
        const newData = { ...testcaseData };
        newData.testSteps = [...(newData.testSteps || [])];
        newData.testSteps[stepIndex] = { ...newData.testSteps[stepIndex] };
        newData.testSteps[stepIndex].expectedResults = [...(newData.testSteps[stepIndex].expectedResults || [])];
        newData.testSteps[stepIndex].expectedResults[resultIndex] = {
          ...newData.testSteps[stepIndex].expectedResults[resultIndex],
          actualResult
        };
        setTestcaseData(newData);
      };

      // Get all variables and their values from the entire testcase
      const getAllVariablesFromTestcase = useCallback(() => {
        const allVars = {};
        if (!testcaseData?.testSteps) return allVars;
        
        testcaseData.testSteps.forEach(step => {
          (step.expectedResults || []).forEach(result => {
            if (result.variables) {
              Object.entries(result.variables).forEach(([key, value]) => {
                if (value) {
                  allVars[key] = value;
                }
              });
            }
          });
        });
        return allVars;
      }, [testcaseData]);

      // Update a variable value in an ExpectedResult
      const updateExpectedResultVariable = (stepIndex, resultIndex, varName, varValue) => {
        const newData = { ...testcaseData };
        newData.testSteps = [...(newData.testSteps || [])];
        newData.testSteps[stepIndex] = { ...newData.testSteps[stepIndex] };
        newData.testSteps[stepIndex].expectedResults = [...(newData.testSteps[stepIndex].expectedResults || [])];
        
        const currentResult = newData.testSteps[stepIndex].expectedResults[resultIndex];
        newData.testSteps[stepIndex].expectedResults[resultIndex] = {
          ...currentResult,
          variables: {
            ...(currentResult.variables || {}),
            [varName]: varValue
          }
        };
        
        setTestcaseData(newData);
      };

      const updateStepErrorMessage = (stepIndex, errorMessage) => {
        const newData = { ...testcaseData };
        newData.testSteps = [...(newData.testSteps || [])];
        newData.testSteps[stepIndex] = { ...newData.testSteps[stepIndex], errorMessage };
        setTestcaseData(newData);
      };

      const updateTestcaseStatus = (status) => {
        const newData = { ...testcaseData };
        newData.status = status;
        newData.timestamp = new Date().toISOString();
        
        // Cascade status to all steps and expected results for any status change
        if (status) {
          newData.testSteps = (newData.testSteps || []).map(step => ({
            ...step,
            status: status,
            expectedResults: (step.expectedResults || []).map(er => ({
              ...er,
              status: status
            }))
          }));
        } else {
          // If status is cleared, clear all child statuses too
          newData.testSteps = (newData.testSteps || []).map(step => ({
            ...step,
            status: null,
            expectedResults: (step.expectedResults || []).map(er => ({
              ...er,
              status: null
            }))
          }));
        }
        
        setTestcaseData(newData);
      };

      const saveResults = async () => {
        setSaving(true);
        try {
          const response = await fetch(
            getApiUrl(instance, `/testcase/${encodeURIComponent(selectedModule.path)}/${encodeURIComponent(selectedCategory.path)}/${encodeURIComponent(selectedTestcase.filename)}`),
            {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(testcaseData)
            }
          );
          const data = await response.json();
          if (response.ok) {
            showNotification('Ergebnisse erfolgreich gespeichert!');
            // Update original data to current data (no more unsaved changes)
            setOriginalTestcaseData(JSON.parse(JSON.stringify(testcaseData)));
            // Reload structure, profiles and dashboard to update status in lists
            loadStructure();
            loadProfiles();
            loadDashboard();
          } else {
            showNotification(data.error, 'error');
          }
        } catch (err) {
          showNotification('Fehler beim Speichern', 'error');
        }
        setSaving(false);
      };

      // ============================================
      // Notes Functions
      // ============================================
      
      const addNote = async () => {
        if (!newNoteText.trim() || !selectedModule || !selectedCategory || !selectedTestcase) return;
        
        setAddingNote(true);
        try {
          const response = await fetch(
            getApiUrl(instance, `/testcase/${encodeURIComponent(selectedModule.path)}/${encodeURIComponent(selectedCategory.path)}/${encodeURIComponent(selectedTestcase.filename)}/notes`),
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ text: newNoteText.trim(), author: '' })
            }
          );
          const data = await response.json();
          if (response.ok) {
            setTestcaseData(prev => ({ ...prev, notes: data.notes }));
            setOriginalTestcaseData(prev => ({ ...prev, notes: data.notes }));
            setNewNoteText('');
            showNotification('Notiz hinzugefügt');
            // Reload structure and dashboard to update counts in lists
            loadStructure();
            loadProfiles();
            loadDashboard();
          } else {
            showNotification(data.error, 'error');
          }
        } catch (err) {
          showNotification('Fehler beim Hinzufügen der Notiz', 'error');
        }
        setAddingNote(false);
      };
      
      const deleteNote = async (noteIndex) => {
        if (!selectedModule || !selectedCategory || !selectedTestcase) return;
        if (!confirm('Notiz wirklich löschen?')) return;
        
        try {
          const response = await fetch(
            getApiUrl(instance, `/testcase/${encodeURIComponent(selectedModule.path)}/${encodeURIComponent(selectedCategory.path)}/${encodeURIComponent(selectedTestcase.filename)}/notes/${noteIndex}`),
            { method: 'DELETE' }
          );
          const data = await response.json();
          if (response.ok) {
            setTestcaseData(prev => ({ ...prev, notes: data.notes }));
            setOriginalTestcaseData(prev => ({ ...prev, notes: data.notes }));
            showNotification('Notiz gelöscht');
            // Reload structure and dashboard to update counts in lists
            loadStructure();
            loadProfiles();
            loadDashboard();
          } else {
            showNotification(data.error, 'error');
          }
        } catch (err) {
          showNotification('Fehler beim Löschen der Notiz', 'error');
        }
      };

      // ============================================
      // Attachments Functions
      // ============================================
      
      const uploadAttachment = async (file) => {
        if (!file || !selectedModule || !selectedCategory || !selectedTestcase) return;
        
        setUploadingFile(true);
        try {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('description', attachmentDescription);
          
          const response = await fetch(
            getApiUrl(instance, `/testcase/${encodeURIComponent(selectedModule.path)}/${encodeURIComponent(selectedCategory.path)}/${encodeURIComponent(selectedTestcase.filename)}/attachments`),
            {
              method: 'POST',
              body: formData
            }
          );
          const data = await response.json();
          if (response.ok) {
            setTestcaseData(prev => ({ ...prev, attachments: data.attachments }));
            setOriginalTestcaseData(prev => ({ ...prev, attachments: data.attachments }));
            setAttachmentDescription('');
            showNotification('Datei hochgeladen');
            // Reload structure and dashboard to update counts in lists
            loadStructure();
            loadProfiles();
            loadDashboard();
          } else {
            showNotification(data.error, 'error');
          }
        } catch (err) {
          showNotification('Fehler beim Hochladen', 'error');
        }
        setUploadingFile(false);
      };
      
      const deleteAttachment = async (attachmentFilename) => {
        if (!selectedModule || !selectedCategory || !selectedTestcase) return;
        if (!confirm('Anhang wirklich löschen?')) return;
        
        try {
          const response = await fetch(
            getApiUrl(instance, `/testcase/${encodeURIComponent(selectedModule.path)}/${encodeURIComponent(selectedCategory.path)}/${encodeURIComponent(selectedTestcase.filename)}/attachments/${encodeURIComponent(attachmentFilename)}`),
            { method: 'DELETE' }
          );
          const data = await response.json();
          if (response.ok) {
            setTestcaseData(prev => ({ ...prev, attachments: data.attachments }));
            setOriginalTestcaseData(prev => ({ ...prev, attachments: data.attachments }));
            showNotification('Anhang gelöscht');
            // Reload structure and dashboard to update counts in lists
            loadStructure();
            loadProfiles();
            loadDashboard();
          } else {
            showNotification(data.error, 'error');
          }
        } catch (err) {
          showNotification('Fehler beim Löschen des Anhangs', 'error');
        }
      };
      
      const getAttachmentUrl = (filename) => {
        if (!testcaseData) return '#';
        return getApiUrl(instance, `/attachments/${encodeURIComponent(testcaseData.id)}/${encodeURIComponent(filename)}`);
      };
      
      const isImageFile = (mimeType) => {
        return mimeType && mimeType.startsWith('image/');
      };
      
      const formatFileSize = (bytes) => {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      };
      
      const formatTimestamp = (timestamp) => {
        if (!timestamp) return '';
        return new Date(timestamp).toLocaleString('de-DE');
      };

      // Parse testcase ID to extract prefix, number, and variant suffix
      // e.g., "II_ERR_01_A" -> { prefix: "II_ERR_", number: 1, variant: "A", baseId: "II_ERR_01", hasVariant: true }
      // e.g., "II_ERR_01" -> { prefix: "II_ERR_", number: 1, variant: null, baseId: "II_ERR_01", hasVariant: false }
      const parseTestcaseId = (id) => {
        // Match pattern: PREFIX_NUMBER or PREFIX_NUMBER_VARIANT
        // First try with variant
        const matchWithVariant = id.match(/^(.+_)(\d+)_([A-Z]+)$/);
        if (matchWithVariant) {
          return { 
            prefix: matchWithVariant[1], 
            number: parseInt(matchWithVariant[2], 10),
            variant: matchWithVariant[3], 
            baseId: matchWithVariant[1] + matchWithVariant[2],
            hasVariant: true 
          };
        }
        // Try without variant
        const matchWithoutVariant = id.match(/^(.+_)(\d+)$/);
        if (matchWithoutVariant) {
          return { 
            prefix: matchWithoutVariant[1], 
            number: parseInt(matchWithoutVariant[2], 10),
            variant: null, 
            baseId: id,
            hasVariant: false 
          };
        }
        // Fallback - no number found
        return { prefix: id, number: 0, variant: null, baseId: id, hasVariant: false };
      };

      // Convert variant to sortable number
      // A=1, B=2, ..., Z=26, AA=27, AB=28, ..., AZ=52, BA=53, ...
      const variantToNumber = (variant) => {
        if (!variant) return 0;
        if (variant.length === 1) {
          return variant.charCodeAt(0) - 64; // A=1, B=2, ..., Z=26
        }
        if (variant.length === 2) {
          const first = variant.charCodeAt(0) - 64; // A=1, B=2, ...
          const second = variant.charCodeAt(1) - 64;
          return 26 + (first - 1) * 26 + second; // AA=27, AB=28, ..., AZ=52, BA=53, ...
        }
        // For longer variants, just use a large offset
        let result = 26 + 26 * 26;
        for (let i = 0; i < variant.length; i++) {
          result = result * 26 + (variant.charCodeAt(i) - 64);
        }
        return result;
      };

      // Convert number back to variant (for gap detection)
      const numberToVariant = (num) => {
        if (num <= 0) return null;
        // Single letters (1-26)
        if (num <= 26) {
          return String.fromCharCode(64 + num);
        }
        // Double letters (27-702)
        const adjusted = num - 26;
        const first = Math.floor((adjusted - 1) / 26) + 1;
        const second = ((adjusted - 1) % 26) + 1;
        return String.fromCharCode(64 + first) + String.fromCharCode(64 + second);
      };

      // Get the next expected variant number
      const getNextVariantNum = (currentNum) => {
        if (currentNum < 26) return currentNum + 1;
        if (currentNum === 26) return 27; // Z -> AA
        return currentNum + 1;
      };

      // Group and sort testcases with variant detection and base ID gap detection
      const groupTestcasesWithVariants = (testcases) => {
        // First, group by prefix (e.g., "II_EXF_")
        const prefixGroups = new Map();
        
        testcases.forEach(tc => {
          const parsed = parseTestcaseId(tc.id);
          if (!prefixGroups.has(parsed.prefix)) {
            prefixGroups.set(parsed.prefix, new Map()); // Map of number -> { base, variants }
          }
          const numberGroup = prefixGroups.get(parsed.prefix);
          if (!numberGroup.has(parsed.number)) {
            numberGroup.set(parsed.number, { base: null, variants: [], prefix: parsed.prefix, number: parsed.number });
          }
          const group = numberGroup.get(parsed.number);
          if (parsed.hasVariant) {
            group.variants.push({ ...tc, _variant: parsed.variant, _variantNum: variantToNumber(parsed.variant), _parsed: parsed });
          } else {
            group.base = { ...tc, _parsed: parsed };
          }
        });

        // Build result with gap detection for both base IDs and variants
        const result = [];
        
        // Sort prefixes
        const sortedPrefixes = Array.from(prefixGroups.keys()).sort();
        
        sortedPrefixes.forEach(prefix => {
          const numberGroups = prefixGroups.get(prefix);
          const sortedNumbers = Array.from(numberGroups.keys()).sort((a, b) => a - b);
          
          let lastNumber = 0;
          
          sortedNumbers.forEach((num, numIdx) => {
            const group = numberGroups.get(num);
            
            // Check for gap in base IDs (only if we have a previous number)
            if (lastNumber > 0 && num > lastNumber + 1) {
              const missingCount = num - lastNumber - 1;
              const fromNum = String(lastNumber).padStart(2, '0');
              const toNum = String(num).padStart(2, '0');
              result.push({ 
                type: 'base-gap', 
                prefix: prefix,
                fromNumber: lastNumber,
                toNumber: num,
                fromId: prefix + fromNum,
                toId: prefix + toNum,
                missingCount: missingCount
              });
            }
            lastNumber = num;
            
            if (group.variants.length === 0) {
              // No variants, just add the base testcase
              if (group.base) {
                result.push({ type: 'testcase', tc: group.base });
              }
            } else {
              // Has variants - add group header
              const baseId = prefix + String(num).padStart(2, '0');
              result.push({ type: 'group-start', baseId, variantCount: group.variants.length + (group.base ? 1 : 0) });
              
              // Add base if exists
              if (group.base) {
                result.push({ type: 'testcase', tc: group.base, isInGroup: true, isBase: true });
              }
              
              // Sort variants
              group.variants.sort((a, b) => a._variantNum - b._variantNum);
              
              // Add variants with gap detection
              let lastVariantNum = 0;
              group.variants.forEach((variant, idx) => {
                // Check for gap in variants
                const expectedNext = getNextVariantNum(lastVariantNum);
                if (lastVariantNum > 0 && variant._variantNum > expectedNext) {
                  // There's a gap - show if within same tier (single vs double letter)
                  const lastInSingleRange = lastVariantNum <= 26;
                  const currentInSingleRange = variant._variantNum <= 26;
                  if (lastInSingleRange === currentInSingleRange) {
                    const gapStart = numberToVariant(lastVariantNum);
                    const gapEnd = numberToVariant(variant._variantNum);
                    const missingCount = variant._variantNum - lastVariantNum - 1;
                    result.push({ 
                      type: 'variant-gap', 
                      from: gapStart, 
                      to: gapEnd,
                      missingCount: missingCount
                    });
                  }
                }
                result.push({ type: 'testcase', tc: variant, isInGroup: true, isVariant: true, variant: variant._variant });
                lastVariantNum = variant._variantNum;
              });
              
              result.push({ type: 'group-end' });
            }
          });
        });

        return result;
      };

      // Get filtered testcases for a category
      // Filter testcases by search text (ID or title)
      const filterTestcasesByText = (testcases) => {
        if (!testcaseFilter.trim()) return testcases;
        const filterLower = testcaseFilter.toLowerCase().trim();
        return testcases.filter(tc => 
          tc.id.toLowerCase().includes(filterLower) || 
          (tc.title && tc.title.toLowerCase().includes(filterLower))
        );
      };

      const getFilteredTestcases = (testcases) => {
        let filtered = testcases;
        
        // Apply profile filter only if checklist is completed
        if (profileConfig && profileConfig.completed) {
          const filterMode = profileConfig.templateConfiguration?.profileFilterMode || 'OR';
          
          filtered = filtered.filter(tc => {
            // If testcase has no profiles, always show
            if (!tc.profiles || tc.profiles.length === 0) return true;
            
            if (filterMode === 'AND') {
              // AND: All profiles of the testcase must be active
              return tc.profiles.every(p => isProfileActive(p));
            } else {
              // OR (default): At least one profile must be active
              return tc.profiles.some(p => isProfileActive(p));
            }
          });
        }
        
        // Then apply text filter
        filtered = filterTestcasesByText(filtered);
        
        return filtered;
      };

      const getTotalTestcases = (filtered = true) => {
        return structure.modules.reduce((sum, mod) => 
          sum + mod.categories.reduce((catSum, cat) => {
            const tcs = filtered ? getFilteredTestcases(cat.testcases) : cat.testcases;
            return catSum + tcs.length;
          }, 0), 0);
      };

      const getStatusCounts = (filtered = true) => {
        let passed = 0, failed = 0, skipped = 0, open = 0;
        structure.modules.forEach(mod => {
          mod.categories.forEach(cat => {
            const testcases = filtered ? getFilteredTestcases(cat.testcases) : cat.testcases;
            testcases.forEach(tc => {
              if (tc.status === 'PASSED') passed++;
              else if (tc.status === 'FAILED') failed++;
              else if (tc.status === 'SKIPPED') skipped++;
              else open++;
            });
          });
        });
        return { passed, failed, skipped, open };
      };

      // Check if filtering is active
      const isFilteringActive = () => {
        return profileConfig && profileConfig.completed && activeProfiles.length > 0;
      };

      if ((loading || checklistLoading) && view === 'loading') {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="loading-spinner mx-auto mb-4"></div>
              <p className="text-gray-600">Lade Anwendung...</p>
            </div>
          </div>
        );
      }

      if (loading && view === 'browser' && structure.modules.length === 0) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="loading-spinner mx-auto mb-4"></div>
              <p className="text-gray-600">Lade Testcases...</p>
            </div>
          </div>
        );
      }

      const statusCounts = getStatusCounts();

      return (
        <div className="h-screen bg-gray-50 flex flex-col overflow-hidden">
          {/* Notification */}
          {notification && (
            <div className={`fixed top-4 right-4 z-50 px-4 py-3 rounded shadow-lg fade-in ${
              notification.type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
            }`}>
              {notification.message}
            </div>
          )}

          {/* Header */}
          <header ref={headerRef} className="bg-gradient-to-r from-blue-800 to-blue-900 text-white px-6 py-3 shadow-lg flex-shrink-0">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-6">
                <div className="flex items-center gap-3">
                  <a 
                    href="/"
                    className="p-1.5 hover:bg-blue-700 rounded transition-colors"
                    title="Zur Instanzauswahl"
                  >
                    <Icon name="home" />
                  </a>
                  <h1 className="text-xl font-bold flex items-center">
                    <Icon name="flask" className="mr-2" />
                    {profileConfig?.metadata?.productName || 'Testcase Manager'}
                  </h1>
                  <span className="px-2 py-0.5 bg-blue-600 rounded text-sm font-normal">
                    {instance}
                  </span>
                </div>
                
                {/* Search Form */}
                <form onSubmit={handleSearchSubmit} className="flex items-center">
                  <div className="relative">
                    <input
                      type="text"
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      placeholder="ID, Titel oder Zweck suchen..."
                      className="w-72 px-4 py-1.5 pl-10 rounded-l text-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300 border-r-0"
                    />
                    <Icon name="search" className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                    {searchQuery && (
                      <button
                        type="button"
                        onClick={clearSearch}
                        className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                      >
                        <Icon name="times" />
                      </button>
                    )}
                  </div>
                  <button
                    type="submit"
                    disabled={isSearching || !searchQuery.trim()}
                    className="px-3 py-1.5 bg-blue-600 rounded-r hover:bg-blue-500 disabled:opacity-50 text-sm border border-blue-600"
                  >
                    {isSearching ? <Icon name="spinner fa-spin" /> : <Icon name="search" />}
                  </button>
                </form>
              </div>
              
              <div className="flex items-center gap-4">
                {/* Status Summary */}
                <div className="flex gap-3 text-sm bg-blue-900/50 rounded px-3 py-1.5" title={isFilteringActive() ? 'Gefiltert nach aktiven Profilen' : 'Alle Testcases'}>
                  {statusCounts.passed > 0 && (
                    <div className="flex items-center gap-1" title="Passed">
                      <span className="w-2 h-2 rounded-full bg-green-400"></span>
                      <span className="font-medium">{statusCounts.passed}</span>
                    </div>
                  )}
                  {statusCounts.failed > 0 && (
                    <div className="flex items-center gap-1" title="Failed">
                      <span className="w-2 h-2 rounded-full bg-red-400"></span>
                      <span className="font-medium">{statusCounts.failed}</span>
                    </div>
                  )}
                  {statusCounts.skipped > 0 && (
                    <div className="flex items-center gap-1" title="Skipped">
                      <span className="w-2 h-2 rounded-full bg-yellow-400"></span>
                      <span className="font-medium">{statusCounts.skipped}</span>
                    </div>
                  )}
                  {statusCounts.open > 0 && (
                    <div className="flex items-center gap-1" title="Offen">
                      <span className="w-2 h-2 rounded-full bg-gray-400"></span>
                      <span className="font-medium">{statusCounts.open}</span>
                    </div>
                  )}
                  {statusCounts.passed === 0 && statusCounts.failed === 0 && statusCounts.skipped === 0 && statusCounts.open === 0 && (
                    <span className="text-blue-300 text-xs">Keine Testcases</span>
                  )}
                  {isFilteringActive() && (
                    <Icon name="filter" className="text-blue-300 text-xs ml-1" title="Gefiltert" />
                  )}
                </div>
                
                {/* Active Profiles Indicator */}
                {profileConfig?.completed && activeProfiles.length > 0 && (
                  <button
                    onClick={openChecklist}
                    className="flex items-center text-xs text-green-300 bg-green-900/30 px-2 py-1 rounded hover:bg-green-900/50 transition-colors"
                    title={`Aktive Profile: ${activeProfiles.join(', ')}`}
                  >
                    <Icon name="filter" className="mr-1" />
                    <span>{activeProfiles.length} Profile aktiv</span>
                  </button>
                )}
                
                {/* Custom Path Indicator (only shown if not default) */}
                {structure.root && structure.root !== './testcases' && (
                  <div className="flex items-center text-xs text-blue-300 bg-blue-900/30 px-2 py-1 rounded" title={structure.root}>
                    <Icon name="folder-open" className="mr-1" />
                    <span className="max-w-32 truncate">{structure.root.split('/').pop() || structure.root}</span>
                  </div>
                )}
                
                {/* Config & Refresh Buttons */}
                <div className="flex items-center border-l border-blue-700 pl-3 gap-1">
                  <button
                    onClick={openChecklist}
                    className={`relative p-2 hover:bg-blue-700 rounded transition-colors ${view === 'checklist' ? 'bg-blue-700' : ''}`}
                    title={profileConfig?.completed 
                      ? `ICS Checkliste ✓ (${activeProfiles.length} Profile aktiv)` 
                      : 'ICS Checkliste (noch nicht ausgefüllt)'}
                  >
                    <Icon name="clipboard-check" />
                    {/* Status indicator */}
                    {profileConfig?.completed ? (
                      <span className="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full border-2 border-blue-800" title="Ausgefüllt"></span>
                    ) : (
                      <span className="absolute -top-1 -right-1 w-3 h-3 bg-orange-400 rounded-full border-2 border-blue-800 animate-pulse" title="Noch nicht ausgefüllt"></span>
                    )}
                  </button>
                  <button
                    onClick={() => { loadStructure(); loadProfiles(); loadHashtags(); loadProfileConfig(); loadDashboard(); }}
                    className="p-2 hover:bg-blue-700 rounded transition-colors"
                    title="Aktualisieren"
                  >
                    <Icon name="sync-alt" />
                  </button>
                </div>
              </div>
            </div>
          </header>

          {/* Error Banner */}
          {error && (
            <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4">
              <div className="flex items-center">
                <Icon name="exclamation-triangle" className="mr-2" />
                <p>{error}</p>
                <button
                  onClick={() => setError(null)}
                  className="ml-4 text-red-700 hover:text-red-900"
                >
                  <Icon name="times" />
                </button>
              </div>
            </div>
          )}

          {/* Main Content */}
          <div className="flex flex-1 overflow-hidden min-h-0">
            
            {/* Checklist View */}
            {view === 'checklist' && profileConfig && (
              <div className="flex-1 overflow-y-auto bg-gray-50">
                <div className="max-w-4xl mx-auto p-8">
                  <div className="mb-8">
                    <h2 className="text-3xl font-bold text-gray-800 mb-2">
                      <Icon name="clipboard-check" className="mr-3 text-blue-600" />
                      Implementation Conformance Statement (ICS)
                    </h2>
                    <p className="text-gray-600">
                      {profileConfig.metadata?.description || 'Bitte füllen Sie die Checkliste aus, um die relevanten Profile zu bestimmen.'}
                    </p>
                    {profileConfig.completed && (
                      <div className="mt-4 p-3 bg-green-100 border border-green-300 rounded-lg flex items-center gap-2">
                        <Icon name="check-circle" className="text-green-600" />
                        <span className="text-green-800">Checkliste ist ausgefüllt. {derivedProfiles.length} Profile aktiv.</span>
                      </div>
                    )}
                  </div>

                  {/* Metadata */}
                  <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4">
                      <Icon name="info-circle" className="mr-2 text-blue-500" />
                      Produktinformationen
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Hersteller</label>
                        <input
                          type="text"
                          value={profileConfig.metadata.manufacturer}
                          onChange={(e) => updateMetadata('manufacturer', e.target.value)}
                          className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:outline-none"
                          placeholder="Name des Herstellers"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Produktname</label>
                        <input
                          type="text"
                          value={profileConfig.metadata.productName}
                          onChange={(e) => updateMetadata('productName', e.target.value)}
                          className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:outline-none"
                          placeholder="Name des Produkts"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Version</label>
                        <input
                          type="text"
                          value={profileConfig.metadata.productVersion}
                          onChange={(e) => updateMetadata('productVersion', e.target.value)}
                          className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:outline-none"
                          placeholder="z.B. 1.0.0"
                        />
                      </div>
                    </div>
                  </div>

                  {/* Sections */}
                  {profileConfig.sections.map((section) => (
                    <div key={section.id} className="bg-white rounded-lg shadow-md mb-4 overflow-hidden">
                      <button
                        onClick={() => toggleSection(section.id)}
                        className="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors"
                      >
                        <div className="flex items-center gap-3">
                          <Icon 
                            name={expandedSections.has(section.id) ? 'chevron-down' : 'chevron-right'} 
                            className="text-gray-500" 
                          />
                          <h3 className="text-lg font-semibold text-gray-800">{section.title}</h3>
                          <span className="text-sm text-gray-500">
                            ({section.questions.filter(q => q.answer.answered && isQuestionDependencySatisfied(profileConfig, q)).length}/{section.questions.filter(q => isQuestionDependencySatisfied(profileConfig, q)).length} beantwortet)
                          </span>
                        </div>
                      </button>
                      
                      {expandedSections.has(section.id) && (
                        <div className="p-4 border-t">
                          {section.description && (
                            <p className="text-gray-600 text-sm mb-4">{section.description}</p>
                          )}
                          
                          <div className="space-y-4">
                            {section.questions.filter(q => isQuestionDependencySatisfied(profileConfig, q)).map((question) => (
                              <div 
                                key={question.id} 
                                className={`p-4 rounded-lg border ${
                                  question.answer.answered 
                                    ? 'bg-blue-50 border-blue-200' 
                                    : question.required 
                                      ? 'bg-yellow-50 border-yellow-200' 
                                      : 'bg-gray-50 border-gray-200'
                                } ${question.dependsOn ? 'ml-6 border-l-4 border-l-blue-300' : ''}`}
                              >
                                {question.dependsOn && (
                                  <div className="text-xs text-blue-500 mb-2 flex items-center gap-1">
                                    <Icon name="level-up-alt fa-rotate-90" />
                                    <span>Abhängige Frage</span>
                                  </div>
                                )}
                                <div className="flex items-start gap-3">
                                  <div className="flex-1">
                                    <p className="font-medium text-gray-800">
                                      {question.text}
                                      {question.required && <span className="text-red-500 ml-1">*</span>}
                                    </p>
                                    {question.helpText && (
                                      <p className="text-sm text-gray-500 mt-1">{question.helpText}</p>
                                    )}
                                    
                                    {/* Answer Input */}
                                    <div className="mt-3">
                                      {question.type === 'boolean' && (
                                        <div className="flex gap-4">
                                          <label className="flex items-center gap-2 cursor-pointer">
                                            <input
                                              type="radio"
                                              name={question.id}
                                              checked={question.answer.values[0] === 'true'}
                                              onChange={() => updateAnswer(section.id, question.id, ['true'])}
                                              className="w-4 h-4 text-blue-600"
                                            />
                                            <span className="text-gray-700">Ja</span>
                                          </label>
                                          <label className="flex items-center gap-2 cursor-pointer">
                                            <input
                                              type="radio"
                                              name={question.id}
                                              checked={question.answer.values[0] === 'false'}
                                              onChange={() => updateAnswer(section.id, question.id, ['false'])}
                                              className="w-4 h-4 text-blue-600"
                                            />
                                            <span className="text-gray-700">Nein</span>
                                          </label>
                                          {question.answer.answered && (
                                            <button
                                              onClick={() => updateAnswer(section.id, question.id, [])}
                                              className="text-sm text-gray-500 hover:text-gray-700 ml-2"
                                            >
                                              <Icon name="times" /> Zurücksetzen
                                            </button>
                                          )}
                                        </div>
                                      )}
                                      
                                      {question.type === 'choice' && (
                                        <div className="space-y-2">
                                          {question.profileMappings.map((mapping, idx) => (
                                            <label key={idx} className="flex items-center gap-2 cursor-pointer">
                                              <input
                                                type="radio"
                                                name={question.id}
                                                checked={question.answer.values.includes(mapping.condition)}
                                                onChange={() => updateAnswer(section.id, question.id, [mapping.condition])}
                                                className="w-4 h-4 text-blue-600"
                                              />
                                              <span className="text-gray-700">
                                                {mapping.condition === 'yes' ? 'Ja' :
                                                 mapping.condition === 'no' ? 'Nein' :
                                                 mapping.condition === 'noagg' ? 'Signiert direkt (nicht aggregiert)' :
                                                 mapping.condition === 'agg' ? 'Aggregiert Updates' :
                                                 mapping.condition === 'both' ? 'Beides (direkt und aggregiert)' :
                                                 mapping.condition === 'limited_tracked' ? 'Begrenzte Anzahl, wird nachgehalten' :
                                                 mapping.condition === 'unlimited_not_tracked' ? 'Unbegrenzte Anzahl, wird nicht nachgehalten' :
                                                 mapping.condition}
                                              </span>
                                              <span className="text-xs text-gray-400 ml-2">
                                                → {mapping.profiles.join(', ')}
                                              </span>
                                            </label>
                                          ))}
                                          {question.answer.answered && (
                                            <button
                                              onClick={() => updateAnswer(section.id, question.id, [])}
                                              className="text-sm text-gray-500 hover:text-gray-700 mt-2"
                                            >
                                              <Icon name="times" /> Zurücksetzen
                                            </button>
                                          )}
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                  
                                  {/* Status Indicator */}
                                  <div className="flex-shrink-0">
                                    {question.answer.answered ? (
                                      <Icon name="check-circle" className="text-green-500 text-xl" />
                                    ) : question.required ? (
                                      <Icon name="exclamation-circle" className="text-yellow-500 text-xl" />
                                    ) : (
                                      <Icon name="circle" className="text-gray-300 text-xl" />
                                    )}
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  ))}

                  {/* Derived Profiles Preview */}
                  <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4">
                      <Icon name="tags" className="mr-2 text-purple-500" />
                      Abgeleitete Profile
                      <span className="text-sm font-normal text-gray-500 ml-2">
                        (werden dynamisch berechnet)
                      </span>
                    </h3>
                    {derivedProfiles.length === 0 ? (
                      <p className="text-gray-500">Noch keine Profile aktiviert. Beantworten Sie die Fragen oben.</p>
                    ) : (
                      <div className="flex flex-wrap gap-2">
                        {derivedProfiles.map((profile) => (
                          <span key={profile} className="px-3 py-1 bg-purple-100 text-purple-800 rounded text-sm">
                            {profile}
                          </span>
                        ))}
                      </div>
                    )}
                    <p className="text-xs text-gray-400 mt-3">
                      <Icon name="info-circle" className="mr-1" />
                      {derivedProfiles.length} Profile aktiv basierend auf Ihren Antworten
                    </p>
                  </div>

                  {/* Action Buttons */}
                  <div className="flex justify-between items-center bg-white rounded-lg shadow-md p-6">
                    <div>
                      {profileConfig.completed && (
                        <button
                          onClick={() => { setView('browser'); setShowChecklist(false); updateUrl('dashboard'); updateTitle('dashboard'); }}
                          className="px-4 py-2 text-gray-600 hover:text-gray-800"
                        >
                          <Icon name="arrow-left" className="mr-2" />
                          Zurück zu den Testcases
                        </button>
                      )}
                    </div>
                    <div className="flex gap-3">
                      <button
                        onClick={() => saveProfileConfig(false)}
                        disabled={saving}
                        className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded transition-colors disabled:opacity-50"
                      >
                        {saving ? <Icon name="spinner fa-spin" className="mr-2" /> : <Icon name="save" className="mr-2" />}
                        Zwischenspeichern
                      </button>
                      <button
                        onClick={() => saveProfileConfig(true)}
                        disabled={saving}
                        className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors disabled:opacity-50"
                      >
                        {saving ? <Icon name="spinner fa-spin" className="mr-2" /> : <Icon name="check" className="mr-2" />}
                        Abschließen & Profile anwenden
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Sidebar - Hidden when showing checklist */}
            {view !== 'checklist' && (
            <aside className="w-80 bg-white border-r flex flex-col flex-shrink-0 overflow-hidden min-h-0">
              {/* Accordion Headers */}
              <div ref={accordionHeadersRef} className="flex-shrink-0 border-b">
                {/* Modules Header */}
                <button
                  onClick={() => setActiveNavSection('modules')}
                  className={`w-full p-3 border-b flex items-center justify-between transition-colors ${
                    activeNavSection === 'modules' ? 'bg-blue-50 text-blue-700' : 'bg-gray-50 text-gray-700 hover:bg-gray-100'
                  }`}
                >
                  <div className="flex items-center gap-2">
                    <Icon name="sitemap" />
                    <span className="font-semibold">Module & Kategorien</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="text-xs bg-gray-200 px-2 py-0.5 rounded">
                      {isFilteringActive() ? `${getTotalTestcases(true)}/${getTotalTestcases(false)}` : getTotalTestcases()}
                    </span>
                    <Icon name={activeNavSection === 'modules' ? 'chevron-down' : 'chevron-right'} className="text-sm" />
                  </div>
                </button>

                {/* Profiles Header */}
                <button
                  onClick={() => setActiveNavSection('profiles')}
                  className={`w-full p-3 border-b flex items-center justify-between transition-colors ${
                    activeNavSection === 'profiles' ? 'bg-purple-50 text-purple-700' : 'bg-gray-50 text-gray-700 hover:bg-gray-100'
                  }`}
                >
                  <div className="flex items-center gap-2">
                    <Icon name="tags" />
                    <span className="font-semibold">Profile</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded">
                      {filterProfiles(profiles).length}
                    </span>
                    <Icon name={activeNavSection === 'profiles' ? 'chevron-down' : 'chevron-right'} className="text-sm" />
                  </div>
                </button>

                {/* Hashtags Header */}
                <button
                  onClick={() => setActiveNavSection('hashtags')}
                  className={`w-full p-3 border-b flex items-center justify-between transition-colors ${
                    activeNavSection === 'hashtags' ? 'bg-teal-50 text-teal-700' : 'bg-gray-50 text-gray-700 hover:bg-gray-100'
                  }`}
                >
                  <div className="flex items-center gap-2">
                    <Icon name="hashtag" />
                    <span className="font-semibold">Hashtags</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="text-xs bg-teal-100 text-teal-700 px-2 py-0.5 rounded">
                      {hashtags.functions.length + hashtags.users.length}
                    </span>
                    <Icon name={activeNavSection === 'hashtags' ? 'chevron-down' : 'chevron-right'} className="text-sm" />
                  </div>
                </button>
              </div>

              {/* Accordion Content - Takes remaining height with calculated max-height */}
              <div ref={navRef} className="overflow-y-auto" style={{ maxHeight: navContentMaxHeight }}>
                {/* Modules Content */}
                {activeNavSection === 'modules' && (
                  <nav className="p-2">
                    {structure.modules.length === 0 ? (
                      <div className="text-center text-gray-500 py-8">
                        <Icon name="folder-open" className="text-4xl mb-2 text-gray-300" />
                        <p>Keine Module gefunden</p>
                      </div>
                    ) : (
                      structure.modules.map((module) => (
                        <div key={module.id} className="mb-1">
                          <button
                            onClick={() => toggleModule(module.id)}
                            className="w-full flex items-center gap-2 px-3 py-2 text-left hover:bg-gray-100 rounded transition-colors"
                          >
                            <Icon 
                              name={expandedModules.has(module.id) ? 'chevron-down' : 'chevron-right'} 
                              className="w-4 text-gray-500" 
                            />
                            <Icon 
                              name={expandedModules.has(module.id) ? 'folder-open' : 'folder'} 
                              className="text-blue-500" 
                            />
                            <span className="font-medium text-gray-700 text-sm truncate">{module.name}</span>
                          </button>
                          
                          {expandedModules.has(module.id) && (
                            <div className="ml-6 mt-1">
                              {module.categories.map((category) => (
                                <button
                                  key={category.id}
                                  onClick={() => selectCategory(module, category)}
                                  className={`w-full flex items-center justify-between gap-2 px-3 py-2 text-left rounded transition-colors ${
                                    selectedCategory?.id === category.id && selectedModule?.id === module.id
                                      ? 'bg-blue-100 text-blue-800' 
                                      : 'hover:bg-gray-100 text-gray-600'
                                  }`}
                                >
                                  <div className="flex items-center gap-2">
                                    <Icon name="folder" className="text-sm" />
                                    <span className="text-sm">{category.name}</span>
                                    {isFilteringActive() && getFilteredTestcases(category.testcases).length !== category.testcases.length && (
                                      <span className="text-xs text-gray-400">
                                        ({getFilteredTestcases(category.testcases).length}/{category.testcases.length})
                                      </span>
                                    )}
                                  </div>
                                  <StatusBubbles testcases={getFilteredTestcases(category.testcases)} />
                                </button>
                              ))}
                            </div>
                          )}
                        </div>
                      ))
                    )}
                  </nav>
                )}

                {/* Profiles Content */}
                {activeNavSection === 'profiles' && (
                  <nav className="p-2">
                    {filterProfiles(profiles).length === 0 ? (
                      <div className="text-center text-gray-500 py-8">
                        <Icon name="tags" className="text-4xl mb-2 text-gray-300" />
                        <p>Keine Profile gefunden</p>
                      </div>
                    ) : (
                      <>
                        {(() => {
                          const coveredProfiles = getCoveredProfiles();
                          const activeProfilesList = filterProfiles(profiles).filter(p => 
                            coveredProfiles.has(p.name)
                          );
                          const uncoveredProfilesList = filterProfiles(profiles).filter(p => 
                            !coveredProfiles.has(p.name)
                          );
                          
                          return (
                            <>
                              {activeProfilesList.length > 0 && (
                                <>
                                  {profileConfig?.completed && uncoveredProfilesList.length > 0 && (
                                    <div className="text-xs text-gray-500 px-3 py-1 font-medium uppercase tracking-wide">
                                      Durch Checkliste bestimmt
                                    </div>
                                  )}
                                  {activeProfilesList.map((profile) => (
                                    <button
                                      key={profile.id}
                                      onClick={() => !profile.isEmpty && selectProfile(profile)}
                                      title={profile.isEmpty 
                                        ? `${profile.name} - Keine TestCases mit diesem Profil`
                                        : (profileConfig?.profileDefinitions?.[profile.name]?.description || profile.name)}
                                      className={`w-full flex items-center justify-between gap-2 px-3 py-2 text-left rounded transition-colors mb-1 ${
                                        profile.isEmpty
                                          ? 'bg-gray-50 text-gray-400 cursor-default'
                                          : selectedProfile?.id === profile.id
                                            ? 'bg-purple-100 text-purple-800' 
                                            : 'hover:bg-gray-100 text-gray-600'
                                      }`}
                                    >
                                      <div className="flex items-center gap-2 min-w-0">
                                        <Icon name="tag" className={profile.isEmpty ? "text-gray-300 text-sm flex-shrink-0" : "text-purple-500 text-sm flex-shrink-0"} />
                                        <span className="text-sm truncate">{profile.name}</span>
                                      </div>
                                      {profile.isEmpty ? (
                                        <span className="text-xs text-gray-400">0</span>
                                      ) : (
                                        <StatusBubbles testcases={profile.testcases} />
                                      )}
                                    </button>
                                  ))}
                                </>
                              )}
                              
                              {uncoveredProfilesList.length > 0 && (
                                <>
                                  <div className="text-xs text-gray-500 px-3 py-1 mt-3 font-medium uppercase tracking-wide border-t pt-3">
                                    <Icon name="question-circle" className="mr-1" />
                                    Nicht durch Checkliste abgedeckt
                                  </div>
                                  {uncoveredProfilesList.map((profile) => (
                                    <button
                                      key={profile.id}
                                      onClick={() => !profile.isEmpty && selectProfile(profile)}
                                      title={profile.isEmpty 
                                        ? `${profile.name} - Keine TestCases mit diesem Profil`
                                        : (profileConfig?.profileDefinitions?.[profile.name]?.description || profile.name)}
                                      className={`w-full flex items-center justify-between gap-2 px-3 py-2 text-left rounded transition-colors mb-1 ${
                                        profile.isEmpty
                                          ? 'bg-gray-50 text-gray-400 cursor-default'
                                          : selectedProfile?.id === profile.id
                                            ? 'bg-orange-100 text-orange-800' 
                                            : 'hover:bg-gray-100 text-gray-500'
                                      }`}
                                    >
                                      <div className="flex items-center gap-2 min-w-0">
                                        <Icon name="tag" className={profile.isEmpty ? "text-gray-300 text-sm flex-shrink-0" : "text-orange-400 text-sm flex-shrink-0"} />
                                        <span className="text-sm truncate">{profile.name}</span>
                                      </div>
                                      {profile.isEmpty ? (
                                        <span className="text-xs text-gray-400">0</span>
                                      ) : (
                                        <StatusBubbles testcases={profile.testcases} />
                                      )}
                                    </button>
                                  ))}
                                </>
                              )}
                            </>
                          );
                        })()}
                      </>
                    )}
                  </nav>
                )}

                {/* Hashtags Content */}
                {activeNavSection === 'hashtags' && (
                  <nav className="p-2">
                    {hashtags.functions.length === 0 && hashtags.users.length === 0 ? (
                      <div className="text-center text-gray-500 py-8">
                        <Icon name="hashtag" className="text-4xl mb-2 text-gray-300" />
                        <p>Keine Hashtags gefunden</p>
                        <p className="text-xs mt-2 text-gray-400">
                          RefFunction und RefUser in XML-Dateien
                        </p>
                      </div>
                    ) : (
                      <>
                        {/* Functions */}
                        {hashtags.functions.length > 0 && (
                          <>
                            <div className="text-xs text-gray-500 px-3 py-1 font-medium uppercase tracking-wide flex items-center gap-1">
                              <Icon name="cog" className="text-cyan-500" />
                              Funktionen ({hashtags.functions.length})
                            </div>
                            {hashtags.functions.map((fn) => (
                              <button
                                key={fn.id}
                                onClick={() => selectHashtag(fn)}
                                title={`${fn.name} - ${fn.testcases.length} TestCase(s)`}
                                className={`w-full flex items-center justify-between gap-2 px-3 py-2 text-left rounded transition-colors mb-1 ${
                                  selectedHashtag?.id === fn.id && selectedHashtag?.type === 'function'
                                    ? 'bg-cyan-100 text-cyan-800' 
                                    : 'hover:bg-gray-100 text-gray-600'
                                }`}
                              >
                                <div className="flex items-center gap-2 min-w-0">
                                  <span className="text-cyan-500 font-bold text-sm">#</span>
                                  <span className="text-sm truncate">{fn.name}</span>
                                </div>
                                <StatusBubbles testcases={fn.testcases} />
                              </button>
                            ))}
                          </>
                        )}
                        
                        {/* Users */}
                        {hashtags.users.length > 0 && (
                          <>
                            <div className="text-xs text-gray-500 px-3 py-1 mt-3 font-medium uppercase tracking-wide flex items-center gap-1 border-t pt-3">
                              <Icon name="user" className="text-pink-500" />
                              Benutzer ({hashtags.users.length})
                            </div>
                            {hashtags.users.map((user) => (
                              <button
                                key={user.id}
                                onClick={() => selectHashtag(user)}
                                title={`${user.name} - ${user.testcases.length} TestCase(s)`}
                                className={`w-full flex items-center justify-between gap-2 px-3 py-2 text-left rounded transition-colors mb-1 ${
                                  selectedHashtag?.id === user.id && selectedHashtag?.type === 'user'
                                    ? 'bg-pink-100 text-pink-800' 
                                    : 'hover:bg-gray-100 text-gray-600'
                                }`}
                              >
                                <div className="flex items-center gap-2 min-w-0">
                                  <span className="text-pink-500 font-bold text-sm">@</span>
                                  <span className="text-sm truncate">{user.name}</span>
                                </div>
                                <StatusBubbles testcases={user.testcases} />
                              </button>
                            ))}
                          </>
                        )}
                      </>
                    )}
                  </nav>
                )}
              </div>
            </aside>
            )}

            {/* Main Area - Hidden when showing checklist */}
            {view !== 'checklist' && (
            <main ref={mainRef} className="flex-1 overflow-y-auto">
              {view === 'browser' && (
                <div className="p-6 fade-in">
                  <div className="flex items-center justify-between mb-6">
                    <h2 className="text-2xl font-bold text-gray-800">
                      <Icon name="tachometer-alt" className="mr-2 text-blue-500" />
                      Dashboard
                    </h2>
                    <div className="flex items-center gap-3">
                      {isFilteringActive() && (
                        <span className="text-sm text-blue-600 bg-blue-50 px-3 py-1 rounded-full">
                          <Icon name="filter" className="mr-1" />
                          Nach Profilen gefiltert
                        </span>
                      )}
                      {/* Export Dropdown */}
                      <div className="relative group">
                        <button
                          className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm"
                          title="Report exportieren"
                        >
                          <Icon name="download" />
                          Export
                          <Icon name="chevron-down" className="ml-1" />
                        </button>
                        <div className="absolute right-0 mt-1 w-56 bg-white rounded-lg shadow-lg border border-gray-200 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
                          <div className="py-1">
                            <button
                              onClick={() => exportPdf()}
                              className="w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"
                            >
                              <Icon name="file-pdf" className="text-red-600" />
                              <div className="text-left">
                                <div className="font-medium">PDF Export</div>
                                <div className="text-xs text-gray-500">Festes Layout</div>
                              </div>
                            </button>
                            <button
                              onClick={() => exportDocx()}
                              className="w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"
                            >
                              <Icon name="file-word" className="text-blue-600" />
                              <div className="text-left">
                                <div className="font-medium">Word Export</div>
                                <div className="text-xs text-gray-500">Formatiertes Dokument</div>
                              </div>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* ICS Status Banner */}
                  {profileConfig && !profileConfig.completed && (
                    <div className="mb-6 bg-orange-50 border border-orange-200 rounded-lg p-4">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <div className="p-2 bg-orange-100 rounded-full">
                            <Icon name="clipboard-list" className="text-orange-600" />
                          </div>
                          <div>
                            <h3 className="font-semibold text-orange-800">ICS Checkliste noch nicht ausgefüllt</h3>
                            <p className="text-sm text-orange-600">Füllen Sie die Checkliste aus, um die relevanten Profile und TestCases zu bestimmen.</p>
                          </div>
                        </div>
                        <button
                          onClick={openChecklist}
                          className="flex items-center gap-2 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors text-sm"
                        >
                          <Icon name="clipboard-check" />
                          Jetzt ausfüllen
                        </button>
                      </div>
                    </div>
                  )}
                  
                  {profileConfig && profileConfig.completed && (
                    <div className="mb-6 bg-green-50 border border-green-200 rounded-lg p-3">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <Icon name="check-circle" className="text-green-600" />
                          <span className="text-green-800">
                            <span className="font-medium">ICS Checkliste ausgefüllt</span>
                            <span className="text-green-600 ml-2">• {activeProfiles.length} Profile aktiv</span>
                          </span>
                        </div>
                        <button
                          onClick={openChecklist}
                          className="text-sm text-green-700 hover:text-green-900 underline"
                        >
                          Bearbeiten
                        </button>
                      </div>
                    </div>
                  )}
                  
                  {(() => {
                    const statusCounts = getStatusCounts();
                    const totalFiltered = getTotalTestcases();
                    const totalAll = getTotalTestcases(false);
                    
                    // Calculate filtered notes and attachments
                    const filteredTestcaseIds = new Set();
                    structure.modules.forEach(mod => {
                      mod.categories.forEach(cat => {
                        getFilteredTestcases(cat.testcases).forEach(tc => {
                          filteredTestcaseIds.add(tc.id);
                        });
                      });
                    });
                    
                    const filteredNotes = dashboardData?.recentNotes?.filter(n => filteredTestcaseIds.has(n.testcaseId)) || [];
                    const filteredAttachments = dashboardData?.recentAttachments?.filter(a => filteredTestcaseIds.has(a.testcaseId)) || [];
                    
                    // Count total notes and attachments from filtered testcases
                    let totalNotes = 0;
                    let totalAttachments = 0;
                    structure.modules.forEach(mod => {
                      mod.categories.forEach(cat => {
                        getFilteredTestcases(cat.testcases).forEach(tc => {
                          totalNotes += tc.notesCount || 0;
                          totalAttachments += tc.attachmentsCount || 0;
                        });
                      });
                    });
                    
                    // Calculate filtered module stats
                    const moduleStats = structure.modules.map(mod => {
                      const stats = { name: mod.name, testcases: 0, passed: 0, failed: 0, skipped: 0, open: 0 };
                      mod.categories.forEach(cat => {
                        const filtered = getFilteredTestcases(cat.testcases);
                        stats.testcases += filtered.length;
                        filtered.forEach(tc => {
                          if (tc.status === 'PASSED') stats.passed++;
                          else if (tc.status === 'FAILED') stats.failed++;
                          else if (tc.status === 'SKIPPED') stats.skipped++;
                          else stats.open++;
                        });
                      });
                      return stats;
                    }).filter(m => m.testcases > 0);
                    
                    return (
                      <>
                        {/* Progress Overview - 5 columns */}
                        <div className="grid grid-cols-5 gap-4 mb-6">
                          <div className="bg-white rounded-lg shadow p-4">
                            <div className="flex items-center justify-between">
                              <div>
                                <p className="text-sm text-gray-500">Gesamt</p>
                                <p className="text-2xl font-bold text-gray-800">{totalFiltered}</p>
                                {isFilteringActive() && totalAll !== totalFiltered && (
                                  <p className="text-xs text-gray-400">von {totalAll}</p>
                                )}
                              </div>
                              <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <Icon name="file-code" className="text-blue-500 text-xl" />
                              </div>
                            </div>
                          </div>
                          <div className="bg-white rounded-lg shadow p-4">
                            <div className="flex items-center justify-between">
                              <div>
                                <p className="text-sm text-gray-500">Bestanden</p>
                                <p className="text-2xl font-bold text-green-600">{statusCounts.passed}</p>
                              </div>
                              <div className="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <Icon name="check-circle" className="text-green-500 text-xl" />
                              </div>
                            </div>
                          </div>
                          <div className="bg-white rounded-lg shadow p-4">
                            <div className="flex items-center justify-between">
                              <div>
                                <p className="text-sm text-gray-500">Fehlgeschlagen</p>
                                <p className="text-2xl font-bold text-red-600">{statusCounts.failed}</p>
                              </div>
                              <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <Icon name="times-circle" className="text-red-500 text-xl" />
                              </div>
                            </div>
                          </div>
                          <div className="bg-white rounded-lg shadow p-4">
                            <div className="flex items-center justify-between">
                              <div>
                                <p className="text-sm text-gray-500">Übersprungen</p>
                                <p className="text-2xl font-bold text-yellow-600">{statusCounts.skipped}</p>
                              </div>
                              <div className="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                                <Icon name="forward" className="text-yellow-500 text-xl" />
                              </div>
                            </div>
                          </div>
                          <div className="bg-white rounded-lg shadow p-4">
                            <div className="flex items-center justify-between">
                              <div>
                                <p className="text-sm text-gray-500">Offen</p>
                                <p className="text-2xl font-bold text-gray-600">{statusCounts.open}</p>
                              </div>
                              <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                                <Icon name="clock" className="text-gray-500 text-xl" />
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Progress Bar */}
                        <div className="bg-white rounded-lg shadow p-4 mb-6">
                          <div className="flex items-center justify-between mb-2">
                            <span className="text-sm font-medium text-gray-700">Fortschritt</span>
                            <span className="text-sm text-gray-500">
                              {totalFiltered > 0 
                                ? Math.round((statusCounts.passed + statusCounts.skipped) / totalFiltered * 100) 
                                : 0}% abgeschlossen
                            </span>
                          </div>
                          <div className="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                            <div className="h-full flex">
                              <div 
                                className="bg-green-500 transition-all duration-500" 
                                style={{ width: `${totalFiltered > 0 ? (statusCounts.passed / totalFiltered * 100) : 0}%` }}
                              />
                              <div 
                                className="bg-yellow-500 transition-all duration-500" 
                                style={{ width: `${totalFiltered > 0 ? (statusCounts.skipped / totalFiltered * 100) : 0}%` }}
                              />
                              <div 
                                className="bg-red-500 transition-all duration-500" 
                                style={{ width: `${totalFiltered > 0 ? (statusCounts.failed / totalFiltered * 100) : 0}%` }}
                              />
                            </div>
                          </div>
                          <div className="flex items-center gap-4 mt-2 text-xs text-gray-500">
                            <span className="flex items-center gap-1"><span className="w-3 h-3 bg-green-500 rounded-sm"></span> Bestanden</span>
                            <span className="flex items-center gap-1"><span className="w-3 h-3 bg-yellow-500 rounded-sm"></span> Übersprungen</span>
                            <span className="flex items-center gap-1"><span className="w-3 h-3 bg-red-500 rounded-sm"></span> Fehlgeschlagen</span>
                            <span className="flex items-center gap-1"><span className="w-3 h-3 bg-gray-200 rounded-sm"></span> Offen</span>
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-6 mb-6">
                          {/* Recent Notes */}
                          <div className="bg-white rounded-lg shadow p-4">
                            <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                              <Icon name="sticky-note" className="text-yellow-500" />
                              Neueste Notizen
                              <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">{totalNotes}</span>
                            </h3>
                            {filteredNotes.length === 0 ? (
                              <p className="text-gray-400 text-sm text-center py-4">Keine Notizen vorhanden</p>
                            ) : (
                              <div className="space-y-2">
                                {filteredNotes.slice(0, 5).map((note, idx) => (
                                  <div 
                                    key={idx} 
                                    className="p-2 bg-yellow-50 rounded border border-yellow-100 cursor-pointer hover:bg-yellow-100 transition-colors"
                                    onClick={() => {
                                      const mod = structure.modules.find(m => m.name === note.module);
                                      const cat = mod?.categories.find(c => c.name === note.category);
                                      const tc = cat?.testcases.find(t => t.filename === note.filename);
                                      if (mod && cat && tc) {
                                        setSelectedModule(mod);
                                        setSelectedCategory(cat);
                                        loadTestcase(tc);
                                      }
                                    }}
                                  >
                                    <p className="text-sm text-gray-700 truncate" title={note.text}>
                                      {note.text.length > 100 ? note.text.substring(0, 100) + '...' : note.text}
                                    </p>
                                    <div className="flex items-center justify-between mt-1 text-xs text-gray-400">
                                      <span className="font-mono text-blue-600">{note.testcaseId}</span>
                                      <span>{formatTimestamp(note.timestamp)}</span>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>

                          {/* Recent Attachments */}
                          <div className="bg-white rounded-lg shadow p-4">
                            <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                              <Icon name="paperclip" className="text-blue-500" />
                              Neueste Anhänge
                              <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">{totalAttachments}</span>
                            </h3>
                            {filteredAttachments.length === 0 ? (
                              <p className="text-gray-400 text-sm text-center py-4">Keine Anhänge vorhanden</p>
                            ) : (
                              <div className="space-y-2">
                                {filteredAttachments.slice(0, 5).map((att, idx) => (
                                  <div 
                                    key={idx} 
                                    className="p-2 bg-blue-50 rounded border border-blue-100 cursor-pointer hover:bg-blue-100 transition-colors"
                                    onClick={() => {
                                      const mod = structure.modules.find(m => m.name === att.module);
                                      const cat = mod?.categories.find(c => c.name === att.category);
                                      const tc = cat?.testcases.find(t => t.filename === att.testcaseFilename);
                                      if (mod && cat && tc) {
                                        setSelectedModule(mod);
                                        setSelectedCategory(cat);
                                        loadTestcase(tc);
                                      }
                                    }}
                                  >
                                    <div className="flex items-center gap-2">
                                      <Icon name={att.mimeType?.includes('image') ? 'image' : att.mimeType?.includes('pdf') ? 'file-pdf' : 'file-alt'} className="text-blue-500" />
                                      <span className="text-sm text-gray-700 truncate flex-1">{att.originalName || att.filename}</span>
                                    </div>
                                    <div className="flex items-center justify-between mt-1 text-xs text-gray-400">
                                      <span className="font-mono text-blue-600">{att.testcaseId}</span>
                                      <span>{formatTimestamp(att.timestamp)}</span>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>

                        {/* Module Stats */}
                        {moduleStats.length > 0 && (
                          <div className="bg-white rounded-lg shadow p-4">
                            <h3 className="font-semibold text-gray-800 mb-3">
                              <Icon name="folder" className="mr-2 text-amber-500" />
                              Module Übersicht
                            </h3>
                            <div className="space-y-3">
                              {moduleStats.map((mod, idx) => {
                                const completed = mod.passed + mod.skipped;
                                const percent = mod.testcases > 0 ? Math.round(completed / mod.testcases * 100) : 0;
                                return (
                                  <div key={idx} className="flex items-center gap-4">
                                    <span className="text-sm text-gray-700 w-48 truncate" title={mod.name}>{mod.name}</span>
                                    <div className="flex-1 bg-gray-200 rounded-full h-2 overflow-hidden">
                                      <div className="h-full flex">
                                        <div className="bg-green-500" style={{ width: `${mod.testcases > 0 ? (mod.passed / mod.testcases * 100) : 0}%` }} />
                                        <div className="bg-yellow-500" style={{ width: `${mod.testcases > 0 ? (mod.skipped / mod.testcases * 100) : 0}%` }} />
                                        <div className="bg-red-500" style={{ width: `${mod.testcases > 0 ? (mod.failed / mod.testcases * 100) : 0}%` }} />
                                      </div>
                                    </div>
                                    <span className="text-xs text-gray-500 w-20 text-right">{completed}/{mod.testcases} ({percent}%)</span>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        )}
                      </>
                    );
                  })()}
                </div>
              )}

              {view === 'search' && (
                <div className="p-6 fade-in">
                  <div className="mb-6">
                    <button
                      onClick={clearSearch}
                      className="flex items-center gap-2 text-gray-600 hover:text-gray-800 mb-4"
                    >
                      <Icon name="arrow-left" />
                      Suche beenden
                    </button>
                    <h2 className="text-2xl font-bold text-gray-800">
                      <Icon name="search" className="mr-2 text-blue-500" />
                      Suchergebnisse
                    </h2>
                    <p className="text-gray-500 mt-1">
                      {searchResults.length} Testcase(s) gefunden für "<span className="font-medium">{searchQuery}</span>"
                    </p>
                  </div>

                  {searchResults.length === 0 ? (
                    <div className="bg-white rounded-lg shadow p-8 text-center">
                      <Icon name="search" className="text-5xl text-gray-300 mb-4" />
                      <h3 className="text-lg font-medium text-gray-700 mb-2">Keine Ergebnisse gefunden</h3>
                      <p className="text-gray-500">
                        Für den Suchbegriff "{searchQuery}" wurden keine Testcases gefunden.
                      </p>
                      <p className="text-gray-400 text-sm mt-2">
                        Suche durchsucht: Testcase-ID, Titel und Zweck
                      </p>
                    </div>
                  ) : (
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                      <table className="w-full">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Testcase ID</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modul / Kategorie</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Treffer in</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                          {groupTestcasesWithVariants(searchResults).map((item, idx) => {
                            if (item.type === 'group-start') {
                              return (
                                <tr key={`group-${item.baseId}`} className="bg-gray-50">
                                  <td colSpan="4" className="px-4 py-2">
                                    <div className="flex items-center gap-2 text-xs text-gray-500">
                                      <Icon name="layer-group" className="text-purple-400" />
                                      <span className="font-medium">{item.baseId}</span>
                                      <span className="text-gray-400">({item.variantCount} Varianten)</span>
                                    </div>
                                  </td>
                                </tr>
                              );
                            }
                            if (item.type === 'group-end') {
                              return (
                                <tr key={`group-end-${idx}`} className="h-2 bg-gray-100">
                                  <td colSpan="4"></td>
                                </tr>
                              );
                            }
                            if (item.type === 'base-gap') {
                              return (
                                <tr key={`base-gap-${idx}`} className="bg-orange-50">
                                  <td colSpan="4" className="px-4 py-1">
                                    <div className="flex items-center gap-2 text-xs text-orange-600">
                                      <Icon name="ellipsis-h" />
                                      <span>{item.missingCount === 1 ? `TestCase ${item.fromId.replace(/_(\d+)$/, '_' + String(item.fromNumber + 1).padStart(2, '0'))} fehlt` : `${item.missingCount} TestCases zwischen ${item.fromId} und ${item.toId}`}</span>
                                    </div>
                                  </td>
                                </tr>
                              );
                            }
                            if (item.type === 'variant-gap') {
                              return (
                                <tr key={`variant-gap-${idx}`} className="bg-yellow-50">
                                  <td colSpan="4" className="px-4 py-1">
                                    <div className="flex items-center gap-2 text-xs text-yellow-600 pl-4">
                                      <Icon name="ellipsis-h" />
                                      <span>{item.missingCount === 1 ? `Variante nach _${item.from} fehlt` : `${item.missingCount} Varianten zwischen _${item.from} und _${item.to}`}</span>
                                    </div>
                                  </td>
                                </tr>
                              );
                            }
                            const result = item.tc;
                            const matchTypeLabels = {
                              id: { label: 'ID', color: 'bg-blue-100 text-blue-800', icon: 'hashtag' },
                              title: { label: 'Titel', color: 'bg-green-100 text-green-800', icon: 'heading' },
                              purpose: { label: 'Zweck', color: 'bg-purple-100 text-purple-800', icon: 'bullseye' },
                              refFunction: { label: 'Funktion', color: 'bg-cyan-100 text-cyan-800', icon: 'cog' },
                              refUser: { label: 'Benutzer', color: 'bg-pink-100 text-pink-800', icon: 'user' }
                            };
                            const matchInfo = matchTypeLabels[result.matchType] || matchTypeLabels.purpose;
                            
                            // Module und Category können Strings oder Objekte sein
                            const moduleId = typeof result.module === 'object' ? result.module.id : result.module;
                            const moduleName = typeof result.module === 'object' ? result.module.name : result.module;
                            const categoryId = typeof result.category === 'object' ? result.category.id : result.category;
                            const categoryName = typeof result.category === 'object' ? result.category.name : result.category;
                            
                            return (
                              <tr 
                                key={`${moduleId}-${categoryId}-${result.id}`} 
                                className={`hover:bg-blue-50 cursor-pointer transition-colors ${item.isInGroup ? 'bg-white' : ''}`}
                                onClick={() => openSearchResult(result)}
                              >
                                <td className={`px-6 py-4 ${item.isInGroup ? 'pl-8' : ''}`}>
                                  <div className="flex items-center gap-2">
                                    {item.isVariant && (
                                      <span className="text-purple-400 text-xs">└</span>
                                    )}
                                    <div>
                                      <span className={`font-mono text-sm font-medium ${result.matchType === 'id' ? 'text-blue-600' : 'text-blue-600'}`}>
                                        {item.isVariant ? (
                                          <>
                                            <span className="text-gray-400">{result.id.replace(/_[A-Z]+$/, '')}_</span>
                                            <span className="text-purple-600 font-bold">{item.variant}</span>
                                          </>
                                        ) : result.id}
                                      </span>
                                      <p className={`text-xs ${result.matchType === 'title' ? 'text-green-600 font-medium' : 'text-gray-500'}`}>
                                        {result.title}
                                      </p>
                                      <HashtagBadges refFunctions={result.refFunctions} refUsers={result.refUsers} maxShow={2} compact={true} />
                                    </div>
                                  </div>
                                </td>
                                <td className="px-6 py-4">
                                  <div className="text-sm">
                                    <span className="text-gray-700">{moduleName}</span>
                                    <span className="text-gray-400 mx-1">/</span>
                                    <span className="text-gray-600">{categoryName}</span>
                                  </div>
                                </td>
                                <td className="px-6 py-4">
                                  <span className={`inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium ${matchInfo.color}`}>
                                    <Icon name={matchInfo.icon} />
                                    {matchInfo.label}
                                  </span>
                                </td>
                                <td className="px-6 py-4">
                                  <StatusBadge status={result.status} />
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
              )}

              {view === 'profile' && selectedProfile && (
                <div className="p-6 fade-in">
                  <div className="mb-6">
                    <button
                      onClick={goBack}
                      className="flex items-center gap-2 text-gray-600 hover:text-gray-800 mb-4"
                    >
                      <Icon name="arrow-left" />
                      Zurück zur Übersicht
                    </button>
                    <h2 className="text-2xl font-bold text-gray-800">
                      <Icon name="tag" className="mr-2 text-purple-500" />
                      Profil: {selectedProfile.name}
                    </h2>
                    
                    {/* Profile Description from ProfileDefinitions */}
                    {profileConfig?.profileDefinitions?.[selectedProfile.name] && (
                      <div className="mt-3 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                        <div className="flex items-start gap-3">
                          <Icon name="info-circle" className="text-purple-500 mt-0.5" />
                          <div>
                            <p className="text-gray-700">{profileConfig.profileDefinitions[selectedProfile.name].description}</p>
                            {profileConfig.profileDefinitions[selectedProfile.name].tableReference && (
                              <p className="text-xs text-purple-600 mt-2">
                                <Icon name="book" className="mr-1" />
                                {profileConfig.profileDefinitions[selectedProfile.name].tableReference} - {profileConfig.profileDefinitions[selectedProfile.name].category}
                              </p>
                            )}
                          </div>
                        </div>
                      </div>
                    )}
                    
                    <div className="flex items-center justify-between mt-3">
                      <p className="text-gray-500">
                        {filterTestcasesByText(selectedProfile.testcases).length} von {selectedProfile.testcases.length} Testcase(s) mit diesem Profil
                        {testcaseFilter && <span className="text-green-500 ml-1">(Textsuche aktiv)</span>}
                      </p>
                      {/* Filter Input */}
                      <div className="relative">
                        <input
                          type="text"
                          value={testcaseFilter}
                          onChange={(e) => setTestcaseFilter(e.target.value)}
                          placeholder="Nach ID oder Titel filtern..."
                          className="w-64 px-4 py-2 pl-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                        />
                        <Icon name="filter" className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                        {testcaseFilter && (
                          <button
                            onClick={() => setTestcaseFilter('')}
                            className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                          >
                            <Icon name="times" />
                          </button>
                        )}
                      </div>
                    </div>
                  </div>

                  {filterTestcasesByText(selectedProfile.testcases).length === 0 ? (
                    <div className="bg-white rounded-lg shadow p-8 text-center">
                      <Icon name="filter" className="text-5xl text-gray-300 mb-4" />
                      <h3 className="text-lg font-medium text-gray-700 mb-2">
                        {testcaseFilter ? 'Keine Treffer' : 'Keine Testcases'}
                      </h3>
                      <p className="text-gray-500">
                        {testcaseFilter 
                          ? `Keine Testcases gefunden für "${testcaseFilter}".`
                          : `Für das Profil "${selectedProfile.name}" wurden keine Testcases gefunden.`}
                      </p>
                      {testcaseFilter && (
                        <button
                          onClick={() => setTestcaseFilter('')}
                          className="mt-4 text-blue-600 hover:text-blue-800 text-sm"
                        >
                          <Icon name="times" className="mr-1" />
                          Filter zurücksetzen
                        </button>
                      )}
                    </div>
                  ) : (
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                      <table className="w-full">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-28">ID</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Titel</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Modul / Kategorie</th>
                            <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Status</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                          {groupTestcasesWithVariants(filterTestcasesByText(selectedProfile.testcases)).map((item, idx) => {
                            if (item.type === 'group-start') {
                              return (
                                <tr key={`group-${item.baseId}`} className="bg-gray-50">
                                  <td colSpan="4" className="px-4 py-2">
                                    <div className="flex items-center gap-2 text-xs text-gray-500">
                                      <Icon name="layer-group" className="text-purple-400" />
                                      <span className="font-medium">{item.baseId}</span>
                                      <span className="text-gray-400">({item.variantCount} Varianten)</span>
                                    </div>
                                  </td>
                                </tr>
                              );
                            }
                            if (item.type === 'group-end') {
                              return (
                                <tr key={`group-end-${idx}`} className="h-2 bg-gray-100">
                                  <td colSpan="4"></td>
                                </tr>
                              );
                            }
                            if (item.type === 'base-gap') {
                              return (
                                <tr key={`base-gap-${idx}`} className="bg-orange-50">
                                  <td colSpan="4" className="px-4 py-1">
                                    <div className="flex items-center gap-2 text-xs text-orange-600">
                                      <Icon name="ellipsis-h" />
                                      <span>{item.missingCount === 1 ? `TestCase ${item.fromId.replace(/_(\d+)$/, '_' + String(item.fromNumber + 1).padStart(2, '0'))} fehlt` : `${item.missingCount} TestCases zwischen ${item.fromId} und ${item.toId}`}</span>
                                    </div>
                                  </td>
                                </tr>
                              );
                            }
                            if (item.type === 'variant-gap') {
                              return (
                                <tr key={`variant-gap-${idx}`} className="bg-yellow-50">
                                  <td colSpan="4" className="px-4 py-1">
                                    <div className="flex items-center gap-2 text-xs text-yellow-600 pl-4">
                                      <Icon name="ellipsis-h" />
                                      <span>{item.missingCount === 1 ? `Variante nach _${item.from} fehlt` : `${item.missingCount} Varianten zwischen _${item.from} und _${item.to}`}</span>
                                    </div>
                                  </td>
                                </tr>
                              );
                            }
                            const tc = item.tc;
                            // Module und Category sind Strings in der Profil-Ansicht
                            const moduleId = typeof tc.module === 'object' ? tc.module.id : tc.module;
                            const moduleName = typeof tc.module === 'object' ? tc.module.name : tc.module;
                            const categoryId = typeof tc.category === 'object' ? tc.category.id : tc.category;
                            const categoryName = typeof tc.category === 'object' ? tc.category.name : tc.category;
                            return (
                              <tr 
                                key={`${moduleId}-${categoryId}-${tc.id}`} 
                                className={`hover:bg-blue-50 cursor-pointer transition-colors ${item.isInGroup ? 'bg-white' : ''}`}
                                onClick={() => openProfileTestcase(tc)}
                              >
                                <td className={`px-4 py-3 ${item.isInGroup ? 'pl-6' : ''}`}>
                                  <div className="flex items-center gap-1">
                                    {item.isVariant && (
                                      <span className="text-purple-400 text-xs">└</span>
                                    )}
                                    <span className="font-mono text-sm text-blue-600 hover:text-blue-800 font-medium">
                                      {item.isVariant ? (
                                        <>
                                          <span className="text-gray-400">{tc.id.replace(/_[A-Z]+$/, '')}_</span>
                                          <span className="text-purple-600 font-bold">{item.variant}</span>
                                        </>
                                      ) : tc.id}
                                    </span>
                                  </div>
                                </td>
                                <td className="px-4 py-3">
                                  <div className="flex items-center gap-2">
                                    <span className="text-gray-900 hover:text-blue-600">{tc.title}</span>
                                    {tc.notesCount > 0 && (
                                      <span className="text-yellow-500" title={`${tc.notesCount} Notiz(en)`}>
                                        <Icon name="sticky-note" />
                                      </span>
                                    )}
                                    {tc.attachmentsCount > 0 && (
                                      <span className="text-blue-500" title={`${tc.attachmentsCount} Anhang/Anhänge`}>
                                        <Icon name="paperclip" />
                                      </span>
                                    )}
                                  </div>
                                </td>
                                <td className="px-4 py-3">
                                  <div className="text-sm text-gray-500">
                                    <span>{moduleName}</span>
                                    <span className="text-gray-300 mx-1">/</span>
                                    <span>{categoryName}</span>
                                  </div>
                                </td>
                                <td className="px-4 py-3 text-center">
                                  <StatusBadge status={tc.status} />
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
              )}

              {/* Hashtag View */}
              {view === 'hashtag' && selectedHashtag && (
                <div className="p-6 fade-in">
                  <div className="mb-6">
                    <button
                      onClick={goBack}
                      className="flex items-center gap-2 text-gray-600 hover:text-gray-800 mb-4"
                    >
                      <Icon name="arrow-left" />
                      Zurück zur Übersicht
                    </button>
                    <h2 className="text-2xl font-bold text-gray-800">
                      <span className={selectedHashtag.type === 'function' ? 'text-cyan-500' : 'text-pink-500'}>
                        {selectedHashtag.type === 'function' ? '#' : '@'}
                      </span>
                      {selectedHashtag.name}
                    </h2>
                    
                    <div className="mt-2 flex items-center gap-2">
                      <span className={`inline-flex items-center text-xs px-2 py-1 rounded ${
                        selectedHashtag.type === 'function' 
                          ? 'bg-cyan-100 text-cyan-700' 
                          : 'bg-pink-100 text-pink-700'
                      }`}>
                        <Icon name={selectedHashtag.type === 'function' ? 'cog' : 'user'} className="mr-1" />
                        {selectedHashtag.type === 'function' ? 'Funktion' : 'Benutzer'}
                      </span>
                    </div>
                    
                    <div className="flex items-center justify-between mt-3">
                      <p className="text-gray-500">
                        {filterTestcasesByText(selectedHashtag.testcases).length} von {selectedHashtag.testcases.length} Testcase(s) mit diesem Hashtag
                        {testcaseFilter && <span className="text-green-500 ml-1">(Textsuche aktiv)</span>}
                      </p>
                      {/* Filter Input */}
                      <div className="relative">
                        <input
                          type="text"
                          value={testcaseFilter}
                          onChange={(e) => setTestcaseFilter(e.target.value)}
                          placeholder="Nach ID oder Titel filtern..."
                          className="w-64 px-4 py-2 pl-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                        />
                        <Icon name="filter" className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                        {testcaseFilter && (
                          <button
                            onClick={() => setTestcaseFilter('')}
                            className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                          >
                            <Icon name="times" />
                          </button>
                        )}
                      </div>
                    </div>
                  </div>

                  {filterTestcasesByText(selectedHashtag.testcases).length === 0 ? (
                    <div className="bg-white rounded-lg shadow p-8 text-center">
                      <Icon name="filter" className="text-5xl text-gray-300 mb-4" />
                      <h3 className="text-lg font-medium text-gray-700 mb-2">
                        {testcaseFilter ? 'Keine Treffer' : 'Keine Testcases'}
                      </h3>
                      <p className="text-gray-500">
                        {testcaseFilter 
                          ? `Keine Testcases gefunden für "${testcaseFilter}".`
                          : `Für das Hashtag "${selectedHashtag.name}" wurden keine Testcases gefunden.`}
                      </p>
                      {testcaseFilter && (
                        <button
                          onClick={() => setTestcaseFilter('')}
                          className="mt-4 text-blue-600 hover:text-blue-800 text-sm"
                        >
                          <Icon name="times" className="mr-1" />
                          Filter zurücksetzen
                        </button>
                      )}
                    </div>
                  ) : (
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                      <table className="w-full">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-28">ID</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Titel</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Modul / Kategorie</th>
                            <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Status</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                          {filterTestcasesByText(selectedHashtag.testcases).map((tc, idx) => {
                            const moduleName = typeof tc.module === 'object' ? tc.module.name : tc.module;
                            const categoryName = typeof tc.category === 'object' ? tc.category.name : tc.category;
                            return (
                              <tr 
                                key={`${tc.module}-${tc.category}-${tc.id}`} 
                                className="hover:bg-blue-50 cursor-pointer transition-colors"
                                onClick={() => openProfileTestcase(tc)}
                              >
                                <td className="px-4 py-3">
                                  <span className="font-mono text-sm text-blue-600 hover:text-blue-800 font-medium">
                                    {tc.id}
                                  </span>
                                </td>
                                <td className="px-4 py-3">
                                  <span className="text-gray-900 hover:text-blue-600">{tc.title}</span>
                                </td>
                                <td className="px-4 py-3">
                                  <div className="text-sm text-gray-500">
                                    <span>{moduleName}</span>
                                    <span className="text-gray-300 mx-1">/</span>
                                    <span>{categoryName}</span>
                                  </div>
                                </td>
                                <td className="px-4 py-3 text-center">
                                  <StatusBadge status={tc.status} />
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
              )}

              {view === 'list' && selectedCategory && (
                <div className="p-6 fade-in">
                  <div className="mb-6">
                    <button
                      onClick={goBack}
                      className="flex items-center gap-2 text-gray-600 hover:text-gray-800 mb-4"
                    >
                      <Icon name="arrow-left" />
                      Zurück zur Übersicht
                    </button>
                    <div className="flex items-center justify-between">
                      <div>
                        <h2 className="text-2xl font-bold text-gray-800">
                          {selectedModule.name} / {selectedCategory.name}
                        </h2>
                        <p className="text-gray-500 mt-1">
                          {getFilteredTestcases(selectedCategory.testcases).length} von {selectedCategory.testcases.length} Testcase(s)
                          {isFilteringActive() && <span className="text-blue-500 ml-1">(nach Profilen gefiltert)</span>}
                          {testcaseFilter && <span className="text-green-500 ml-1">(Textsuche aktiv)</span>}
                        </p>
                      </div>
                      {/* Filter Input */}
                      <div className="relative">
                        <input
                          type="text"
                          value={testcaseFilter}
                          onChange={(e) => setTestcaseFilter(e.target.value)}
                          placeholder="Nach ID oder Titel filtern..."
                          className="w-64 px-4 py-2 pl-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                        />
                        <Icon name="filter" className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                        {testcaseFilter && (
                          <button
                            onClick={() => setTestcaseFilter('')}
                            className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                          >
                            <Icon name="times" />
                          </button>
                        )}
                      </div>
                    </div>
                  </div>

                  {getFilteredTestcases(selectedCategory.testcases).length === 0 ? (
                    <div className="bg-white rounded-lg shadow p-8 text-center">
                      <Icon name="filter" className="text-5xl text-gray-300 mb-4" />
                      <h3 className="text-lg font-medium text-gray-700 mb-2">Keine Testcases nach Filterung</h3>
                      <p className="text-gray-500">
                        {testcaseFilter 
                          ? `Keine Testcases gefunden für "${testcaseFilter}".` 
                          : `${selectedCategory.testcases.length} Testcase(s) wurden durch die Profil-Filter ausgeblendet.`}
                      </p>
                      {testcaseFilter ? (
                        <button
                          onClick={() => setTestcaseFilter('')}
                          className="mt-4 text-blue-600 hover:text-blue-800 text-sm"
                        >
                          <Icon name="times" className="mr-1" />
                          Filter zurücksetzen
                        </button>
                      ) : (
                        <button
                          onClick={openChecklist}
                          className="mt-4 text-blue-600 hover:text-blue-800 text-sm"
                        >
                          <Icon name="clipboard-check" className="mr-1" />
                          Filter in der Checkliste anpassen
                        </button>
                      )}
                    </div>
                  ) : (
                  <div className="bg-white rounded-lg shadow overflow-hidden">
                    <table className="w-full">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-28">ID</th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Titel</th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-36">Profile</th>
                          <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Status</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {groupTestcasesWithVariants(getFilteredTestcases(selectedCategory.testcases)).map((item, idx) => {
                          if (item.type === 'group-start') {
                            return (
                              <tr key={`group-${item.baseId}`} className="bg-gray-50">
                                <td colSpan="4" className="px-4 py-2">
                                  <div className="flex items-center gap-2 text-xs text-gray-500">
                                    <Icon name="layer-group" className="text-purple-400" />
                                    <span className="font-medium">{item.baseId}</span>
                                    <span className="text-gray-400">({item.variantCount} Varianten)</span>
                                  </div>
                                </td>
                              </tr>
                            );
                          }
                          if (item.type === 'group-end') {
                            return (
                              <tr key={`group-end-${idx}`} className="h-2 bg-gray-100">
                                <td colSpan="4"></td>
                              </tr>
                            );
                          }
                          if (item.type === 'base-gap') {
                            return (
                              <tr key={`base-gap-${idx}`} className="bg-orange-50">
                                <td colSpan="4" className="px-4 py-1">
                                  <div className="flex items-center gap-2 text-xs text-orange-600">
                                    <Icon name="ellipsis-h" />
                                    <span>{item.missingCount === 1 ? `TestCase ${item.fromId.replace(/_(\d+)$/, '_' + String(item.fromNumber + 1).padStart(2, '0'))} fehlt` : `${item.missingCount} TestCases zwischen ${item.fromId} und ${item.toId}`}</span>
                                  </div>
                                </td>
                              </tr>
                            );
                          }
                          if (item.type === 'variant-gap') {
                            return (
                              <tr key={`variant-gap-${idx}`} className="bg-yellow-50">
                                <td colSpan="4" className="px-4 py-1">
                                  <div className="flex items-center gap-2 text-xs text-yellow-600 pl-4">
                                    <Icon name="ellipsis-h" />
                                    <span>{item.missingCount === 1 ? `Variante nach _${item.from} fehlt` : `${item.missingCount} Varianten zwischen _${item.from} und _${item.to}`}</span>
                                  </div>
                                </td>
                              </tr>
                            );
                          }
                          const tc = item.tc;
                          return (
                            <tr 
                              key={tc.id} 
                              className={`hover:bg-blue-50 cursor-pointer transition-colors ${item.isInGroup ? 'bg-white' : ''}`}
                              onClick={() => loadTestcase(tc)}
                            >
                              <td className={`px-4 py-3 ${item.isInGroup ? 'pl-6' : ''}`}>
                                <div className="flex items-center gap-1">
                                  {item.isVariant && (
                                    <span className="text-purple-400 text-xs">└</span>
                                  )}
                                  <span className="font-mono text-sm text-blue-600 hover:text-blue-800 font-medium">
                                    {item.isVariant ? (
                                      <>
                                        <span className="text-gray-400">{tc.id.replace(/_[A-Z]+$/, '')}_</span>
                                        <span className="text-purple-600 font-bold">{item.variant}</span>
                                      </>
                                    ) : tc.id}
                                  </span>
                                </div>
                              </td>
                              <td className="px-4 py-3">
                                <div>
                                  <div className="flex items-center gap-2">
                                    <span className="text-gray-900 hover:text-blue-600">{tc.title}</span>
                                    {tc.notesCount > 0 && (
                                      <span className="text-yellow-500" title={`${tc.notesCount} Notiz(en)`}>
                                        <Icon name="sticky-note" />
                                      </span>
                                    )}
                                    {tc.attachmentsCount > 0 && (
                                      <span className="text-blue-500" title={`${tc.attachmentsCount} Anhang/Anhänge`}>
                                        <Icon name="paperclip" />
                                      </span>
                                    )}
                                  </div>
                                  <HashtagBadges refFunctions={tc.refFunctions} refUsers={tc.refUsers} maxShow={3} />
                                </div>
                              </td>
                              <td className="px-4 py-3">
                                <div className="flex flex-wrap gap-1">
                                  {tc.profiles && tc.profiles.length > 0 ? (
                                    <>
                                      {tc.profiles.slice(0, 2).map((profile, pidx) => (
                                        <span 
                                          key={pidx}
                                          className={`text-xs px-1.5 py-0.5 rounded ${
                                            activeProfiles.includes(profile) 
                                              ? 'bg-purple-100 text-purple-700' 
                                              : 'bg-gray-100 text-gray-500'
                                          }`}
                                        >
                                          {profile}
                                        </span>
                                      ))}
                                      {tc.profiles.length > 2 && (
                                        <span className="text-xs text-gray-400" title={tc.profiles.slice(2).join(', ')}>
                                          +{tc.profiles.length - 2}
                                        </span>
                                      )}
                                    </>
                                  ) : (
                                    <span className="text-xs text-gray-300">-</span>
                                  )}
                                </div>
                              </td>
                              <td className="px-4 py-3 text-center">
                                <StatusBadge status={tc.status} />
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                  )}
                </div>
              )}

              {view === 'detail' && testcaseData && (
                <div className="p-6 fade-in">
                  <div className="mb-6 flex items-start justify-between">
                    <div>
                      <button
                        onClick={goBack}
                        className="flex items-center gap-2 text-gray-600 hover:text-gray-800 mb-4"
                      >
                        <Icon name="arrow-left" />
                        {showSearchResults ? 'Zurück zur Suche' : selectedProfile ? 'Zurück zum Profil' : selectedHashtag ? 'Zurück zum Hashtag' : 'Zurück zur Liste'}
                      </button>
                      <div className="flex items-center gap-3">
                        <h2 className="text-2xl font-bold text-gray-800">
                          <span className="text-blue-600">{testcaseData.id}</span>
                          <span className="mx-2 text-gray-400">–</span>
                          {testcaseData.title}
                        </h2>
                        <StatusBadge status={testcaseData.status} />
                      </div>
                      <p className="text-gray-500 mt-1">Version {testcaseData.version}</p>
                    </div>
                    <div className="flex flex-col items-end gap-2">
                      <div className="flex items-center gap-3">
                        <span className="text-sm text-gray-500">Testcase Status:</span>
                        <StatusSelector value={testcaseData.status} onChange={updateTestcaseStatus} />
                      </div>
                      <p className="text-xs text-gray-400">Status wird automatisch berechnet oder manuell auf SKIPPED gesetzt</p>
                      <button
                        onClick={saveResults}
                        disabled={saving || !hasTestcaseChanges}
                        className={`flex items-center gap-2 px-4 py-2 rounded transition-colors mt-2 disabled:opacity-50 disabled:cursor-not-allowed ${
                          hasTestcaseChanges 
                            ? 'bg-green-600 text-white hover:bg-green-700' 
                            : 'bg-gray-300 text-gray-500'
                        }`}
                        title={hasTestcaseChanges ? 'Änderungen speichern' : 'Keine Änderungen vorhanden'}
                      >
                        <Icon name={saving ? 'spinner fa-spin' : 'save'} />
                        {saving ? 'Speichern...' : hasTestcaseChanges ? 'Ergebnisse speichern' : 'Keine Änderungen'}
                      </button>
                    </div>
                  </div>

                  {testcaseData.timestamp && (
                    <div className="mb-4 flex items-center gap-2 text-sm text-gray-500">
                      <Icon name="clock" />
                      Zuletzt aktualisiert: {new Date(testcaseData.timestamp).toLocaleString('de-DE')}
                    </div>
                  )}

                  {/* Purpose */}
                  <div className="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 className="font-semibold text-gray-800 mb-3">
                      <Icon name="bullseye" className="mr-2 text-blue-500" />
                      Zweck (Purpose)
                    </h3>
                    <p className="text-gray-600 whitespace-pre-line">{testcaseData.purpose}</p>
                  </div>

                  {/* Metadata Grid */}
                  <div className="grid grid-cols-3 gap-6 mb-6">
                    {/* Module/Category Info */}
                    <div className="bg-white rounded-lg shadow p-6">
                      <h3 className="font-semibold text-gray-800 mb-3">
                        <Icon name="folder-tree" className="mr-2 text-amber-500" />
                        Modul / Kategorie
                      </h3>
                      <div className="space-y-2">
                        <div className="flex items-center gap-2">
                          <Icon name="folder" className="text-amber-400" />
                          <span className="text-sm text-gray-600">{selectedModule?.name || 'Unbekannt'}</span>
                        </div>
                        <div className="flex items-center gap-2 ml-4">
                          <Icon name="folder-open" className="text-amber-300" />
                          <span className="text-sm text-gray-600">{selectedCategory?.name || 'Unbekannt'}</span>
                        </div>
                      </div>
                    </div>
                    
                    {/* Profiles with active/inactive status */}
                    <div className="bg-white rounded-lg shadow p-6">
                      <h3 className="font-semibold text-gray-800 mb-3">
                        <Icon name="tags" className="mr-2 text-purple-500" />
                        Profile
                      </h3>
                      <div className="flex flex-wrap gap-2">
                        {testcaseData.profiles.map((profile, i) => {
                          const isActive = activeProfiles.includes(profile);
                          const profileDef = profileConfig?.profileDefinitions?.[profile];
                          const tooltipText = profileDef 
                            ? `${profileDef.description}${isActive ? ' (Aktiv)' : ' (Inaktiv)'}`
                            : (isActive ? `Profil "${profile}" aktiv` : `Profil "${profile}" nicht aktiv`);
                          return isActive ? (
                            <button
                              key={i}
                              onClick={() => navigateToProfile(profile)}
                              className="px-3 py-1 bg-purple-100 text-purple-800 rounded text-sm hover:bg-purple-200 transition-colors cursor-pointer flex items-center gap-1"
                              title={tooltipText}
                            >
                              <Icon name="tag" className="text-xs" />
                              {profile}
                              <Icon name="check" className="text-green-500 text-xs ml-1" title="Aktives Profil" />
                            </button>
                          ) : (
                            <span
                              key={i}
                              className="px-3 py-1 bg-gray-100 text-gray-500 rounded text-sm flex items-center gap-1"
                              title={tooltipText}
                            >
                              <Icon name="tag" className="text-xs" />
                              {profile}
                            </span>
                          );
                        })}
                      </div>
                    </div>
                    
                    {/* References */}
                    <div className="bg-white rounded-lg shadow p-6">
                      <h3 className="font-semibold text-gray-800 mb-3">
                        <Icon name="book" className="mr-2 text-blue-500" />
                        Referenzen
                      </h3>
                      <div className="flex flex-wrap gap-2">
                        {testcaseData.references.map((ref, i) => (
                          <span key={i} className="px-3 py-1 bg-blue-100 text-blue-800 rounded text-sm">
                            {ref}
                          </span>
                        ))}
                      </div>
                    </div>
                  </div>

                  {/* Hashtags */}
                  {((testcaseData.refFunctions && testcaseData.refFunctions.length > 0) || (testcaseData.refUsers && testcaseData.refUsers.length > 0)) && (
                    <div className="bg-white rounded-lg shadow p-6 mb-6">
                      <h3 className="font-semibold text-gray-800 mb-3">
                        <Icon name="hashtag" className="mr-2 text-teal-500" />
                        Hashtags
                      </h3>
                      <div className="flex flex-wrap gap-2">
                        {(testcaseData.refFunctions || []).map((fn, i) => (
                          <button
                            key={`fn-${i}`}
                            onClick={() => {
                              const hashtagObj = hashtags.functions.find(h => h.name === fn);
                              if (hashtagObj) selectHashtag(hashtagObj);
                            }}
                            className="px-3 py-1 bg-cyan-100 text-cyan-700 rounded text-sm hover:bg-cyan-200 transition-colors cursor-pointer flex items-center gap-1"
                            title={`Funktion: ${fn}`}
                          >
                            <span className="font-bold">#</span>
                            {fn}
                          </button>
                        ))}
                        {(testcaseData.refUsers || []).map((user, i) => (
                          <button
                            key={`user-${i}`}
                            onClick={() => {
                              const hashtagObj = hashtags.users.find(h => h.name === user);
                              if (hashtagObj) selectHashtag(hashtagObj);
                            }}
                            className="px-3 py-1 bg-pink-100 text-pink-700 rounded text-sm hover:bg-pink-200 transition-colors cursor-pointer flex items-center gap-1"
                            title={`Benutzer: ${user}`}
                          >
                            <span className="font-bold">@</span>
                            {user}
                          </button>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Preconditions */}
                  {testcaseData.preconditions && testcaseData.preconditions.length > 0 && (
                    <div className="bg-white rounded-lg shadow p-6 mb-6">
                      <h3 className="font-semibold text-gray-800 mb-3">
                        <Icon name="clipboard-check" className="mr-2 text-green-500" />
                        Vorbedingungen (Preconditions)
                      </h3>
                      <ul className="space-y-2">
                        {testcaseData.preconditions.map((pc, i) => (
                          <li key={i} className="flex items-start gap-3">
                            <Icon name="check-square" className="text-gray-400 mt-1" />
                            <span className="text-gray-600">{pc}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {/* Test Steps */}
                  <div className="bg-white rounded-lg shadow p-6">
                    <h3 className="font-semibold text-gray-800 mb-4">
                      <Icon name="list-ol" className="mr-2 text-orange-500" />
                      Testschritte ({testcaseData.testSteps?.length || 0})
                    </h3>
                    <div className="space-y-6">
                      {(testcaseData.testSteps || []).map((step, stepIndex) => (
                        <div key={step.id || stepIndex} className={`border rounded-lg p-4 ${
                          step.status === 'PASSED' ? 'bg-green-50 border-green-200' :
                          step.status === 'FAILED' ? 'bg-red-50 border-red-200' :
                          step.status === 'SKIPPED' ? 'bg-yellow-50 border-yellow-200' :
                          'bg-gray-50 border-gray-200'
                        }`}>
                          <div className="flex items-start justify-between mb-3">
                            <h4 className="font-medium text-gray-800">
                              <span className="inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-200 text-gray-700 text-sm mr-2">
                                {step.number || stepIndex + 1}
                              </span>
                              Schritt {step.id}
                            </h4>
                            <StatusBadge status={step.status} />
                          </div>
                          
                          <div className="mb-4">
                            <div className="text-sm text-gray-500 mb-1">Kommando:</div>
                            <div className="text-gray-700 bg-white p-3 rounded border">
                              <VariableText 
                                text={step.command} 
                                allVariables={getAllVariablesFromTestcase()}
                                showValues={true}
                              />
                            </div>
                            {/* Step-Level Hashtags */}
                            {((step.refFunctions && step.refFunctions.length > 0) || (step.refUsers && step.refUsers.length > 0)) && (
                              <div className="mt-2">
                                <HashtagBadges refFunctions={step.refFunctions} refUsers={step.refUsers} maxShow={5} />
                              </div>
                            )}
                          </div>

                          <div className="mb-4">
                            <div className="text-sm text-gray-500 mb-2">Erwartete Ergebnisse:</div>
                            <div className="space-y-3">
                              {(step.expectedResults || []).map((result, resultIndex) => (
                                <div key={result.id || resultIndex} className={`p-3 rounded border ${
                                  result.status === 'PASSED' ? 'bg-green-50 border-green-200' :
                                  result.status === 'FAILED' ? 'bg-red-50 border-red-200' :
                                  result.status === 'SKIPPED' ? 'bg-yellow-50 border-yellow-200' :
                                  'bg-white border-gray-200'
                                }`}>
                                  <div className="flex items-start justify-between gap-4 mb-2">
                                    <div className="text-gray-700 flex-1">
                                      <Icon 
                                        name={
                                          result.status === 'PASSED' ? 'check-circle' : 
                                          result.status === 'FAILED' ? 'times-circle' : 
                                          result.status === 'SKIPPED' ? 'minus-circle' : 
                                          'circle'
                                        } 
                                        className={`mr-2 ${
                                          result.status === 'PASSED' ? 'text-green-500' : 
                                          result.status === 'FAILED' ? 'text-red-500' : 
                                          result.status === 'SKIPPED' ? 'text-yellow-500' : 
                                          'text-gray-300'
                                        }`}
                                      />
                                      <VariableText 
                                        text={result.text}
                                        variables={result.variables || {}}
                                        allVariables={getAllVariablesFromTestcase()}
                                        onVariableClick={(varName, varValue) => updateExpectedResultVariable(stepIndex, resultIndex, varName, varValue)}
                                      />
                                    </div>
                                    <StatusSelector 
                                      value={result.status} 
                                      onChange={(status) => updateExpectedResultStatus(stepIndex, resultIndex, status)}
                                      size="small"
                                    />
                                  </div>
                                  {result.status && (
                                    <div className="mt-2">
                                      <input
                                        type="text"
                                        placeholder="Tatsächliches Ergebnis eingeben..."
                                        value={result.actualResult || ''}
                                        onChange={(e) => updateExpectedResultActual(stepIndex, resultIndex, e.target.value)}
                                        className="w-full text-sm px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      />
                                    </div>
                                  )}
                                </div>
                              ))}
                            </div>
                          </div>

                          {step.status === 'FAILED' && (
                            <div>
                              <div className="text-sm text-gray-500 mb-1">
                                <Icon name="exclamation-triangle" className="mr-1 text-red-500" />
                                Fehlermeldung:
                              </div>
                              <textarea
                                placeholder="Fehlermeldung eingeben..."
                                value={step.errorMessage || ''}
                                onChange={(e) => updateStepErrorMessage(stepIndex, e.target.value)}
                                className="w-full text-sm px-3 py-2 border border-red-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500 bg-red-50"
                                rows={2}
                              />
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Alternative Test Procedures */}
                  {testcaseData.alternativeTestProcedures && testcaseData.alternativeTestProcedures.length > 0 && (
                    <div className="bg-white rounded-lg shadow p-6 mt-6">
                      <h3 className="font-semibold text-gray-800 mb-3 text-red-600">
                        <Icon name="exchange-alt" className="mr-2" />
                        Alternative Testverfahren
                      </h3>
                      <div className="space-y-3">
                        {testcaseData.alternativeTestProcedures.map((alt, i) => (
                          <div key={i} className="p-3 bg-red-50 border border-red-200 rounded">
                            <span className="font-medium text-red-700">Option {String.fromCharCode(65 + i)}:</span>
                            <p className="text-gray-700 mt-1">{alt}</p>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Notes and Attachments Section */}
                  <div className="grid grid-cols-2 gap-6 mt-6">
                    {/* Notes */}
                    <div className="bg-white rounded-lg shadow p-6">
                      <h3 className="font-semibold text-gray-800 mb-4 flex items-center justify-between">
                        <span>
                          <Icon name="sticky-note" className="mr-2 text-yellow-500" />
                          Notizen
                          {testcaseData.notes && testcaseData.notes.length > 0 && (
                            <span className="ml-2 text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">
                              {testcaseData.notes.length}
                            </span>
                          )}
                        </span>
                      </h3>
                      
                      {/* Add Note Form */}
                      <div className="mb-4">
                        <textarea
                          value={newNoteText}
                          onChange={(e) => setNewNoteText(e.target.value)}
                          placeholder="Neue Notiz hinzufügen..."
                          className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 text-sm"
                          rows={3}
                        />
                        <button
                          onClick={addNote}
                          disabled={!newNoteText.trim() || addingNote}
                          className="mt-2 px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center gap-2"
                        >
                          <Icon name={addingNote ? 'spinner fa-spin' : 'plus'} />
                          {addingNote ? 'Wird hinzugefügt...' : 'Notiz hinzufügen'}
                        </button>
                      </div>
                      
                      {/* Notes List */}
                      <div className="space-y-3 max-h-80 overflow-y-auto">
                        {(!testcaseData.notes || testcaseData.notes.length === 0) ? (
                          <p className="text-gray-400 text-sm text-center py-4">
                            <Icon name="sticky-note" className="mr-1" />
                            Noch keine Notizen vorhanden
                          </p>
                        ) : (
                          testcaseData.notes.map((note, index) => (
                            <div key={index} className="p-3 bg-yellow-50 border border-yellow-200 rounded-lg group">
                              <div className="flex justify-between items-start">
                                <p className="text-gray-700 text-sm whitespace-pre-wrap flex-1">{note.text}</p>
                                <button
                                  onClick={() => deleteNote(index)}
                                  className="ml-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                  title="Notiz löschen"
                                >
                                  <Icon name="trash" />
                                </button>
                              </div>
                              {note.timestamp && (
                                <p className="text-xs text-gray-400 mt-2">
                                  <Icon name="clock" className="mr-1" />
                                  {formatTimestamp(note.timestamp)}
                                  {note.author && <span className="ml-2">von {note.author}</span>}
                                </p>
                              )}
                            </div>
                          ))
                        )}
                      </div>
                    </div>

                    {/* Attachments */}
                    <div className="bg-white rounded-lg shadow p-6">
                      <h3 className="font-semibold text-gray-800 mb-4 flex items-center justify-between">
                        <span>
                          <Icon name="paperclip" className="mr-2 text-blue-500" />
                          Anhänge
                          {testcaseData.attachments && testcaseData.attachments.length > 0 && (
                            <span className="ml-2 text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">
                              {testcaseData.attachments.length}
                            </span>
                          )}
                        </span>
                      </h3>
                      
                      {/* Upload Form */}
                      <div className="mb-4">
                        <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-400 transition-colors">
                          <input
                            type="file"
                            id="file-upload"
                            className="hidden"
                            onChange={(e) => {
                              if (e.target.files[0]) {
                                uploadAttachment(e.target.files[0]);
                                e.target.value = '';
                              }
                            }}
                            disabled={uploadingFile}
                          />
                          <label htmlFor="file-upload" className="cursor-pointer">
                            <Icon name={uploadingFile ? 'spinner fa-spin' : 'cloud-upload-alt'} className="text-3xl text-gray-400 mb-2" />
                            <p className="text-sm text-gray-500">
                              {uploadingFile ? 'Wird hochgeladen...' : 'Klicken oder Datei hierher ziehen'}
                            </p>
                            <p className="text-xs text-gray-400 mt-1">
                              PDF, Bilder, Office-Dokumente (max. 50MB)
                            </p>
                          </label>
                        </div>
                      </div>
                      
                      {/* Attachments List */}
                      <div className="space-y-3 max-h-80 overflow-y-auto">
                        {(!testcaseData.attachments || testcaseData.attachments.length === 0) ? (
                          <p className="text-gray-400 text-sm text-center py-4">
                            <Icon name="paperclip" className="mr-1" />
                            Noch keine Anhänge vorhanden
                          </p>
                        ) : (
                          testcaseData.attachments.map((attachment, index) => (
                            <div key={index} className="p-3 bg-gray-50 border border-gray-200 rounded-lg group">
                              <div className="flex items-start gap-3">
                                {/* Thumbnail or Icon */}
                                {isImageFile(attachment.mimeType) ? (
                                  <a 
                                    href={getAttachmentUrl(attachment.filename)} 
                                    target="_blank"
                                    className="flex-shrink-0"
                                  >
                                    <img 
                                      src={getAttachmentUrl(attachment.filename)} 
                                      alt={attachment.originalName}
                                      className="w-16 h-16 object-cover rounded border"
                                    />
                                  </a>
                                ) : (
                                  <div className="w-12 h-12 bg-blue-100 rounded flex items-center justify-center flex-shrink-0">
                                    <Icon 
                                      name={attachment.mimeType?.includes('pdf') ? 'file-pdf' : 'file-alt'} 
                                      className="text-blue-500 text-xl" 
                                    />
                                  </div>
                                )}
                                
                                {/* File Info */}
                                <div className="flex-1 min-w-0">
                                  <a 
                                    href={getAttachmentUrl(attachment.filename)}
                                    target="_blank"
                                    className="text-sm font-medium text-blue-600 hover:text-blue-800 truncate block"
                                    title={attachment.originalName}
                                  >
                                    {attachment.originalName}
                                  </a>
                                  <p className="text-xs text-gray-500 mt-1">
                                    {formatFileSize(attachment.size)}
                                    {attachment.timestamp && (
                                      <span className="ml-2">
                                        <Icon name="clock" className="mr-1" />
                                        {formatTimestamp(attachment.timestamp)}
                                      </span>
                                    )}
                                  </p>
                                  {attachment.description && (
                                    <p className="text-xs text-gray-600 mt-1">{attachment.description}</p>
                                  )}
                                </div>
                                
                                {/* Actions */}
                                <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                  <a
                                    href={getAttachmentUrl(attachment.filename)}
                                    download={attachment.originalName}
                                    className="text-gray-400 hover:text-blue-500"
                                    title="Herunterladen"
                                  >
                                    <Icon name="download" />
                                  </a>
                                  <button
                                    onClick={() => deleteAttachment(attachment.filename)}
                                    className="text-gray-400 hover:text-red-500"
                                    title="Löschen"
                                  >
                                    <Icon name="trash" />
                                  </button>
                                </div>
                              </div>
                            </div>
                          ))
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </main>
            )}
          </div>
        </div>
      );
    }

    // App Wrapper - Decides between Instance Selector and Testcase Manager
    function App() {
      const [instance, setInstance] = useState(null);
      const [checking, setChecking] = useState(true);

      useEffect(() => {
        const currentInstance = getInstanceFromPath();
        setInstance(currentInstance);
        setChecking(false);
      }, []);

      if (checking) {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      if (!instance) {
        return <InstanceSelector />;
      }

      return <TestcaseManager instance={instance} />;
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
